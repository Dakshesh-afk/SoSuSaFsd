@page "/category/{Id:int}"
@rendermode InteractiveServer
@inherits CategoryDetailsBase
@using SoSuSaFsd.Components.Pages.CategoryDetailsComponents
@using SoSuSaFsd.Components.Pages.CategoryDetailsComponents.Sections
@using SoSuSaFsd.Components.Common
@using SoSuSaFsd.Components.Common.PostCardComponents

<PageTitle>@State.Title</PageTitle>
<link rel="stylesheet" href="/styles/category-details.css" />

@* HEADER *@
<CategoryDetailsHeader OnRefresh="@RefreshPage" />

@* MAIN LAYOUT *@
<div class="main-layout">
    @* LEFT SIDEBAR *@
    <CategoryLeftSidebar 
        State="@State"
        OnCategoryClick="@NavigateToCategory"
        OnCategorySearch="@HandleCategorySearch" />

    @* MAIN CONTENT *@
    <main class="feed-area">
        <CategoryMainContent 
            State="@State"
            FocusPostId="@FocusPostId"
            CanUserPost="@CanUserPost()"
            OnToggleFollow="@ToggleFollow"
            OnClearSearch="@ClearSearchAndNavigate"
            OnLike="@ToggleLike"
            OnComment="@ToggleComments"
            OnReport="@OpenReportModal"
            OnUpdateDraft="@UpdateCommentDraftWrapper"
            OnSubmitComment="@SubmitComment"
            OnCarouselChange="@UpdateCarouselIndexWrapper"
            OnToggleReply="@ToggleReplyBox"
            OnUpdateReplyDraft="@UpdateReplyDraftWrapper"
            OnSubmitReply="@SubmitReplyWrapper"
            OnShowPostModal="@ShowPostModal"
            OnShowRequestModal="@ShowRequestModal" />
    </main>

    @* RIGHT SIDEBAR *@
    <SharedRightSidebar 
        VerifiedCategories="@State.VerifiedCategories"
        RecentCategories="@State.RecentCategories"
        OnCategoryClick="@NavigateToCategory"
        EmptyAuthorizedMessage="You haven't created any categories yet."
        EmptyUnauthorizedMessage="Login to see your categories." />
</div>

@* MODALS *@
<CategoryModals 
    State="@State"
    OnFilesSelected="@HandleFilesSelected"
    OnRemoveFile="@RemoveFile"
    OnCreatePost="@HandleCreatePost"
    OnSubmitRequest="@HandleSubmitRequest"
    OnSubmitReport="@SubmitReport"
    OnNavigateToCreate="@NavigateToCreate" />

@code {
    private void UpdateCommentDraftWrapper(PostCardComments.CommentDraftEventArgs args)
    {
        UpdateCommentDraft(args.PostId, args.Content);
    }

    private void UpdateCarouselIndexWrapper(PostCardMedia.CarouselEventArgs args)
    {
        State.CarouselIndices[args.PostId] = args.Index;
        StateHasChanged();
    }

    private void UpdateReplyDraftWrapper(PostCardComments.ReplyDraftEventArgs args)
    {
        UpdateReplyDraft(args.ParentCommentId, args.Content);
    }

    private async Task SubmitReplyWrapper(PostCardComments.SubmitReplyEventArgs args)
    {
        await SubmitReply(args.PostId, args.ParentCommentId);
    }

    private void ShowPostModal()
    {
        // Check if user is logged in before showing modal
        if (string.IsNullOrEmpty(State.CurrentUserId))
        {
            State.ShowLoginOverlay = true;
            return;
        }
        
        State.ShowPostModal = true;
        StateHasChanged();
    }

    private void ShowRequestModal()
    {
        // Check if user is logged in before showing modal
        if (string.IsNullOrEmpty(State.CurrentUserId))
        {
            State.ShowLoginOverlay = true;
            return;
        }
        
        State.ShowRequestModal = true;
        StateHasChanged();
    }
}
