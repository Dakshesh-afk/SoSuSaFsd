@page "/"
@rendermode InteractiveServer
@using SoSuSaFsd.Components.Common
@using SoSuSaFsd.Data
@using SoSuSaFsd.Domain
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using System.ComponentModel.DataAnnotations
@using System.IO
@inject IDbContextFactory<SoSuSaFsdContext> DbFactory
@inject IServiceScopeFactory ScopeFactory
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider
@inject IWebHostEnvironment Environment
@inject SoSuSaFsd.Services.IPostService PostService
@inject SoSuSaFsd.Services.ICategoryService CategoryService

<PageTitle>SoSuSa - Home</PageTitle>

<header class="site-header">
    <div class="header-container">
        <div class="logo-area" onclick="showSection('home')">
            <div class="logo-icon"><i class="fas fa-check"></i></div>
            <span class="logo-text">SoSuSa</span>
        </div>
        <nav class="main-nav">
            <a onclick="showSection('home')" id="nav-home" class="active-link">Home</a>
            <a onclick="showSection('profile')" id="nav-profile">Profile</a>
            <a onclick="showSection('settings')" id="nav-settings">Settings</a>
        </nav>
        <div class="header-right">
            <div class="header-search-wrapper" id="header-search-wrapper" style="display: flex;">
                <input type="text" id="header-search-input" class="search-bar" placeholder="Search posts..." @bind="headerSearchTerm" @bind:event="oninput" @onkeyup="async (e) => await HandleHeaderSearch()">
                <button type="button" class="header-search-btn" title="Search" @onclick="async () => await HandleHeaderSearch()">
                    <i class="fas fa-search"></i>
                </button>
            </div>

            @* --- REFRESH BUTTON --- *@
            <button class="login-btn secondary" style="min-width: 40px; padding: 0 10px; margin-left: 10px;" title="Refresh Page" @onclick="RefreshPage">
                <i class="fas fa-redo"></i>
            </button>

            <AuthorizeView>
                <Authorized>
                    <AuthorizeView Roles="Admin" Context="innerContext">
                        <button class="admin-btn" style="margin-right: 10px;" @onclick="NavigateToAdmin">Admin Panel</button>
                    </AuthorizeView>
                    <button class="login-btn" @onclick="ForceLogout">Logout</button>
                </Authorized>
                <NotAuthorized>
                    <button class="login-btn" onclick="showLoginOverlay()">Login</button>
                </NotAuthorized>
            </AuthorizeView>
        </div>
    </div>
</header>

@* --- SEARCH RESULTS DROPDOWN --- *@
@if (HasSearchedPosts && PostSearchResults != null && PostSearchResults.Any() && currentActiveSection == "home")
{
    <div style="position: fixed; top: 72px; right: 20px; background: white; border: 1px solid #ddd; border-radius: 8px; width: 400px; max-height: 400px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 999;">
        <div style="padding: 10px 0;">
            <div style="padding: 10px 15px; border-bottom: 1px solid #eee; font-weight: bold; color: #666; font-size: 12px;">Search Results (@PostSearchResults.Count)</div>
            @foreach (var post in PostSearchResults)
            {
                <div style="padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; hover:background: #f9f9f9; display: flex; gap: 10px; align-items: flex-start;" @onclick='@(() => OnSearchPostClicked(post.CategoryId, post.Id))'>
                    <div style="width: 40px; height: 40px; border-radius: 50%; background-image: url('@(post.User?.ProfileImage ?? "")'); background-size: cover; background-position: center; flex-shrink: 0;"></div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600, font-size: 13px; color: #222;">@(post.User?.DisplayName ?? post.User?.UserName ?? "Unknown")</div>
                        <div style="font-size: 12px; color: #666;">@(post.Content.Length > 60 ? post.Content.Substring(0, 60) + "..." : post.Content)</div>
                        <div style="font-size: 11px, color: #999; margin-top: 4px;">#@(post.Category?.CategoryName ?? "Unknown") • @post.DateCreated.ToString("MMM dd")</div>
                    </div>
                </div>
            }
        </div>
    </div>
}
else if (HasSearchedPosts && (PostSearchResults == null || !PostSearchResults.Any()) && currentActiveSection == "home")
{
    <div style="position: fixed; top: 72px; right: 20px; background: white; border: 1px solid #ddd; border-radius: 8px; width: 400px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 999; text-align: center; color: #999;">
        <p>No posts found matching "@headerSearchTerm"</p>
    </div>
}
else if (HasSearchedUsers && UserSearchResults != null && UserSearchResults.Any() && currentActiveSection == "profile")
{
    <div style="position: fixed; top: 72px; right: 20px; background: white; border: 1px solid #ddd; border-radius: 8px; width: 400px; max-height: 400px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 999;">
        <div style="padding: 10px 0;">
            <div style="padding: 10px 15px; border-bottom: 1px solid #eee; font-weight: bold; color: #666; font-size: 12px;">Search Results (@UserSearchResults.Count)</div>
            @foreach (var user in UserSearchResults)
            {
                <div style="padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; hover:background: #f9f9f9; display: flex; gap: 10px; align-items: flex-start;" @onclick='@(() => OnSearchUserClicked(user.UserName))'>
                    <div style="width: 40px; height: 40px; border-radius: 50%; background-image: url('@(user.ProfileImage ?? "")'); background-size: cover; background-position: center; flex-shrink: 0;"></div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; font-size: 13px, color: #222;">@(user.DisplayName ?? user.UserName ?? "Unknown")</div>
                        <div style="font-size: 12px, color: #666;">@user.UserName</div>
                    </div>
                </div>
            }
        </div>
    </div>
}
else if (HasSearchedUsers && (UserSearchResults == null || !UserSearchResults.Any()) && currentActiveSection == "profile")
{
    <div style="position: fixed; top: 72px; right: 20px; background: white; border: 1px solid #ddd; border-radius: 8px; width: 400px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 999; text-align: center; color: #999;">
        <p>No users found matching "@headerSearchTerm"</p>
    </div>
}

<div class="main-layout">
    @* --- LEFT SIDEBAR (FOLLOWING + PINNED SEARCH) --- *@
    <aside class="sidebar sidebar-left">
        <div id="sidebar-home" class="section-view active">
            <div class="sidebar-section scrollable-list">
                <h3>Following</h3>
                <ul class="category-list">
                    @if (FollowedCategories != null && FollowedCategories.Any())
                    {
                        @foreach (var cat in FollowedCategories)
                        {
                            <li>
                                <a class="category-link" href="#" @onclick:preventDefault @onclick='@(() => NavigateToCategory(cat.Id))'>
                                    <span class="link-text-wrapper"><span class="hashtag">#</span> @cat.CategoryName</span>
                                    @if (cat.IsVerified)
                                    {
                                        <i class="fas fa-check-circle verified-badge" title="Verified"></i>
                                    }
                                </a>
                            </li>
                        }
                    }
                    else
                    {
                        <p style="color:#666; font-size:14px; margin-top:5px; padding-left:10px;">You are not following any categories.</p>
                    }
                </ul>
            </div>

            <div class="sidebar-footer">
                <div class="category-search-container">
                    <input type="text" placeholder="Search/Create categories" @bind="searchTerm" @bind:event="oninput" />
                    <button type="button" class="create-cat-btn" title="Search or Create Category" @onclick="HandleCategorySearch">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>

        <div id="sidebar-profile" class="section-view">
            <div class="profile-card">
                @* SIDEBAR AVATAR *@
                <div class="profile-avatar-large" style="background-image: url('@(currentUser?.ProfileImage ?? "")'); background-size: cover; background-position: center; border-radius: 50%;"></div>
                <h2 class="profile-name">@(currentUser?.UserName ?? "Guest")</h2>
                <p class="profile-handle">@@@(currentUser?.UserName?.ToLower() ?? "guest")</p>
                <p class="profile-bio">@(currentUser?.Bio ?? "No bio available")</p>
                <div class="profile-stats">
                    <div class="stat-item" onclick="showSection('profile')"><b>@UserPosts.Count</b><span>Posts</span></div>
                    <div class="stat-item" onclick="showSection('following')"><b>@FollowedCategories.Count</b><span>Following</span></div>
                </div>
                <button class="edit-profile-btn" onclick="showSection('settings')">Edit Profile</button>
            </div>
        </div>

        <div id="sidebar-settings" class="section-view">
            <div class="sidebar-section">
                <h3>Account</h3>
                <ul class="category-list">
                    <li><a onclick="showSettingsForm('profile')" id="set-link-profile" class="category-link active-setting">Edit Profile</a></li>
                    <li><a onclick="showSettingsForm('password')" id="set-link-password" class="category-link">Change Password</a></li>
                    <li><a onclick="showSettingsForm('verification')" id="set-link-verification" class="category-link">Request Verification</a></li>
                </ul>
            </div>
        </div>
    </aside>

    <main class="feed-area">
        @* --- HOME FEED --- *@
        <div id="feed-home" class="section-view active">
            <div class="feed-header">
                <div class="feed-header-top">
                    <h1 class="page-title">Home</h1>
                    <button class="create-post-btn" onclick="alert('Join a category to post!')">Create Post</button>
                </div>
            </div>
            <hr />

            @if (FeedPosts != null && FeedPosts.Any())
            {
                @if (DebugRenderPosts)
                {
                    <div style="background:#fffbe6; padding:12px; border-radius:8px; margin-bottom:12px;">
                        <h4 style="margin-top:0;">Debug: FeedPosts (simple render)</h4>
                        @foreach (var post in FeedPosts)
                        {
                            <div class="debug-post" style="padding:10px; border:1px dashed #ccc; margin-bottom:10px; background:#fff;">
                                <div style="font-size:14px; color:#666; margin-bottom:6px;"><strong>Category:</strong> @(post.Category?.CategoryName ?? "(none)") (Id: @post.CategoryId)</div>
                                <div style="font-weight:700;">@(post.User?.UserName ?? "Unknown") <span style="font-weight:400; color:#999;">• @post.DateCreated.ToString("MMM dd, yyyy • HH:mm")</span></div>
                                <div style="margin-top:6px;">@post.Content</div>
                                <div style="margin-top:8px; font-size:13px; color:#666;">Media: @(post.Media?.Count ?? 0) | Likes: @(post.Likes?.Count ?? 0)</div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    @foreach (var post in FeedPosts)
                    {
                        <PostCard Post="post" CurrentUser="currentUser" OnLike="ToggleLike" OnComment="ToggleComments"
                                  OnReport="OpenReportModal" ShowComments="_showComments" PostComments="_postComments"
                                  CommentDrafts="_commentDrafts" OnUpdateDraft="UpdateCommentDraft"
                                  OnSubmitComment="SubmitComment" CarouselIndices="_carouselIndices" OnCarouselChange="UpdateCarouselIndex"
                                  ActiveReplyBoxes="_activeReplyBoxes" ReplyDrafts="_replyDrafts" OnToggleReply="ToggleReplyBox"
                                  OnUpdateReplyDraft="UpdateReplyDraft" OnSubmitReply="SubmitReply" />
                    }
                }
            }
            else
            {
                <div style="text-align: center; color: #666; margin-top: 40px; padding: 20px;">
                    <h3>Your feed is empty.</h3>
                    <p>Follow categories to see posts here!</p>
                </div>
            }
        </div>

        @* --- PROFILE FEED --- *@
        <div id="feed-profile" class="section-view">
            <h1 class="page-title">My Posts</h1>
            <hr />
            @if (UserPosts != null && UserPosts.Any())
            {
                @foreach (var post in UserPosts)
                {
                    <PostCard Post="post" CurrentUser="currentUser" OnLike="ToggleLike" OnComment="ToggleComments"
                              OnReport="OpenReportModal" ShowComments="_showComments" PostComments="_postComments"
                              CommentDrafts="_commentDrafts" OnUpdateDraft="UpdateCommentDraft"
                              OnSubmitComment="SubmitComment" CarouselIndices="_carouselIndices" OnCarouselChange="UpdateCarouselIndex"
                              ActiveReplyBoxes="_activeReplyBoxes" ReplyDrafts="_replyDrafts" OnToggleReply="ToggleReplyBox"
                              OnUpdateReplyDraft="UpdateReplyDraft" OnSubmitReply="SubmitReply" />
                }
            }
            else
            {
                <p style="text-align:center; color:#666;">No posts yet.</p>
            }
        </div>

        @* --- FOLLOWING FEED --- *@
        <div id="feed-following" class="section-view">
            <h1 class="page-title">Following</h1>
            <hr />
            @if (FollowedCategories != null && FollowedCategories.Any())
            {
                <div class="following-grid">
                    @foreach (var cat in FollowedCategories)
                    {
                        <div class="following-card">
                            <h3>
                                #@cat.CategoryName @if (cat.IsVerified)
                                {
                                    <i class="fas fa-check-circle verified-badge" title="Verified"></i>
                                }
                            </h3>
                            <button class="login-btn secondary" @onclick="() => UnfollowCategory(cat.Id)">Unfollow</button>
                        </div>
                    }
                </div>
            }
            else
            {
                <p style="text-align:center; color:#666; margin-top:30px;">You are not following any categories.</p>
            }
        </div>

        @* --- SETTINGS AREA --- *@
        <div id="feed-settings" class="section-view">
            <div id="settings-form-profile" class="settings-content active">
                <h1 class="page-title">Edit Profile</h1>
                <hr />
                <div class="post-card" style="padding: 20px;">
                    @if (currentUser != null)
                    {
                        <form @onsubmit="UpdateProfile">
                            <div class="settings-form-group" style="display:flex; flex-direction:column; align-items:center;">
                                @* SETTINGS EDIT AVATAR *@
                                <div class="profile-avatar-large" style="background-image: url('@(currentUser?.ProfileImage ?? "")'); margin: 0 auto 15px; width: 120px; height: 120px; background-size: cover; background-position: center; border-radius: 50%;"></div>
                                <label class="login-btn secondary" style="cursor: pointer; font-weight:normal; font-size:13px; padding: 5px 15px; position: relative; overflow: hidden;">
                                    Change Photo
                                    <InputFile OnChange="HandleProfileImageSelected" accept=".jpg,.jpeg,.png" style="position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer;" />
                                </label>
                            </div>
                            <div class="settings-form-group"><label>Display Name</label><input type="text" @bind="currentUser.DisplayName" /></div>
                            <div class="settings-form-group"><label>Bio</label><textarea rows="4" @bind="currentUser.Bio"></textarea></div>
                            @if (!string.IsNullOrEmpty(updateStatusMessage))
                            {
                                <div class="@(updateStatusMessage.Contains("Error") ? "error-msg" : "success-msg")">@updateStatusMessage</div>
                            }
                            <button type="submit" class="login-btn">Save Changes</button>
                        </form>
                    }
                    else
                    {
                        <p>Please login to edit profile.</p>
                    }
                </div>
            </div>

            <div id="settings-form-password" class="settings-content hidden">
                <h1 class="page-title">Change Password</h1>
                <hr />
                <div class="post-card" style="padding: 20px;">
                    <EditForm Model="passwordModel" OnValidSubmit="HandlePasswordChange" FormName="passwordChangeForm">
                        <DataAnnotationsValidator />
                        <div class="settings-form-group"><label>Current Password</label><InputText type="password" @bind-Value="passwordModel.OldPassword" /><ValidationMessage For="() => passwordModel.OldPassword" class="text-danger" /></div>
                        <div class="settings-form-group"><label>New Password</label><InputText type="password" @bind-Value="passwordModel.NewPassword" /><ValidationMessage For="() => passwordModel.NewPassword" class="text-danger" /></div>
                        <div class="settings-form-group"><label>Confirm New Password</label><InputText type="password" @bind-Value="passwordModel.ConfirmPassword" /><ValidationMessage For="() => passwordModel.ConfirmPassword" class="text-danger" /></div>
                        @if (!string.IsNullOrEmpty(passwordMessage))
                        {
                            <div class="@(isPasswordSuccess ? "success-msg" : "error-msg")">@passwordMessage</div>
                        }
                        <button type="submit" class="login-btn">Update Password</button>
                    </EditForm>
                </div>
            </div>

            <div id="settings-form-verification" class="settings-content hidden">
                <h1 class="page-title">Request Category Access</h1>
                <hr />
                <div class="post-card" style="padding: 20px;">
                    <p style="margin-bottom: 20px; color: #666;">Request access to post in verified categories. Your request will be reviewed by administrators.</p>
                    @if (!string.IsNullOrEmpty(accessRequestMessage))
                    {
                        <div class="@(isAccessRequestSuccess ? "success-msg" : "error-msg")">@accessRequestMessage</div>
                    }
                    <form @onsubmit="HandleAccessRequest" @onsubmit:preventDefault>
                        <div class="settings-form-group">
                            <label>Select Category</label>
                            <select @bind="selectedCategoryId" class="settings-form-group" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                                <option value="0">-- Select a verified category --</option>
                                @foreach (var cat in VerifiedCategoriesForRequest)
                                {
                                    <option value="@cat.Id"># @cat.CategoryName</option>
                                }
                            </select>
                        </div>
                        <div class="settings-form-group">
                            <label>Reason for Request</label>
                            <textarea rows="5" @bind="accessRequestReason" placeholder="Explain why you need access..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box; resize: vertical;"></textarea>
                        </div>
                        @{
                            bool isSubmitDisabled = currentUser == null || selectedCategoryId == 0 || string.IsNullOrWhiteSpace(accessRequestReason);
                        }
                        <button type="submit" class="login-btn" disabled="@isSubmitDisabled">Submit Request</button>
                    </form>

                    @if (UserAccessRequests != null && UserAccessRequests.Any())
                    {
                        <hr style="margin: 30px 0;" />
                        <h3 style="margin-bottom: 15px;">Your Requests</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            @foreach (var request in UserAccessRequests.OrderByDescending(r => r.DateCreated))
                            {
                                <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                        <div>
                                            <strong># @request.Category?.CategoryName</strong>
                                            <div style="font-size: 12px; color: #666; margin-top: 5px;">@request.DateCreated.ToString("MMM dd, yyyy")</div>
                                        </div>
                                        <span style="padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold; text-transform: uppercase; background: @(request.Status == "Approved" ? "#d4edda" : request.Status == "Rejected" ? "#f8d7da" : "#fff3cd"); color: @(request.Status == "Approved" ? "#155724" : request.Status == "Rejected" ? "#721c24" : "#856404");">@request.Status</span>
                                    </div>
                                    @if (!string.IsNullOrEmpty(request.Reason))
                                    {
                                        <div style="font-size: 14px; color: #555; margin-top: 8px;"><strong>Reason:</strong> @request.Reason</div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </main>

    @* --- RIGHT SIDEBAR (VERIFIED + RECENTLY CREATED) --- *@
    <aside class="sidebar sidebar-right" id="right-sidebar">
        <div class="sidebar-section">
            <h3>Verified Categories</h3>
            <ul class="category-list">
                @if (VerifiedCategories != null)
                {
                    @foreach (var cat in VerifiedCategories)
                    {
                        <li><a class="category-link" href="#" @onclick:preventDefault @onclick='@(() => NavigateToCategory(cat.Id))'><span class="link-text-wrapper"><span class="hashtag">#</span> @cat.CategoryName</span> <i class="fas fa-check-circle verified-badge" title="Verified"></i></a></li>
                    }
                }
            </ul>
        </div>
        <div class="sidebar-section">
            <h3>Recently Created</h3>
            <ul class="category-list">
                @if (RecentCategories != null && RecentCategories.Any())
                {
                    @foreach (var cat in RecentCategories)
                    {
                        <li>
                            <a class="category-link" href="#" @onclick:preventDefault @onclick='@(() => NavigateToCategory(cat.Id))'>
                                <span class="link-text-wrapper"><span class="hashtag">#</span> @cat.CategoryName</span>
                                @if (cat.IsVerified)
                                {
                                    <i class="fas fa-check-circle verified-badge" title="Verified"></i>
                                }
                            </a>
                        </li>
                    }
                }
                else
                {
                    <AuthorizeView>
                        <Authorized><li style="color:#666; padding-left:10px;">No categories created yet.</li></Authorized>
                        <NotAuthorized><li style="color:#666; padding-left:10px;">Login to see your categories.</li></NotAuthorized>
                    </AuthorizeView>
                }
            </ul>
        </div>
    </aside>
</div>

@* --- REPORT POST MODAL --- *@
@if (showReportModal)
{
    <div class="modal" style="display:flex;">
        <div class="modal-content">
            <span class="modal-close" @onclick="() => showReportModal = false">&times;</span>
            <h2 style="margin-top: 0; color: #dc3545;">Report Content</h2>
            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                Help us keep the community safe. Why are you reporting this post?
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">Reason:</label>
                <select class="modal-textarea" style="height: 40px;" @bind="reportReasonSelection">
                    <option value="Spam">Spam</option>
                    <option value="Harassment">Harassment or Bullying</option>
                    <option value="Misinformation">Misinformation</option>
                    <option value="Hate Speech">Hate Speech</option>
                    <option value="Inappropriate">Inappropriate Content</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">Additional Details (Optional):</label>
                <textarea class="modal-textarea" placeholder="Please provide more details..." @bind="reportReasonDetails"></textarea>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top:15px;">
                <button class="login-btn secondary" @onclick="() => showReportModal = false">Cancel</button>
                <button class="login-btn" style="background-color: #dc3545;" @onclick="SubmitReport">Submit Report</button>
            </div>
        </div>
    </div>
}

@* --- NOTIFICATION MODAL --- *@
@if (showNotificationModal)
{
    <div class="modal" style="display:flex;">
        <div class="modal-content" style="text-align: center; max-width: 400px;">
            <span class="modal-close" @onclick="CloseNotification">&times;</span>

            <div style="margin-bottom: 15px;">
                @if (notificationType == "success")
                {
                    <i class="fas fa-check-circle" style="font-size: 48px; color: #28a745;"></i>
                    <h2 style="margin: 10px 0; color: #28a745;">Success</h2>
                }
                else if (notificationType == "info")
                {
                    <i class="fas fa-info-circle" style="font-size: 48px; color: #17a2b8;"></i>
                    <h2 style="margin: 10px 0; color: #17a2b8;">Report Received</h2>
                }
                else
                {
                    <i class="fas fa-exclamation-circle" style="font-size: 48px; color: #dc3545;"></i>
                    <h2 style="margin: 10px 0; color: #dc3545;">Error</h2>
                }
            </div>

            <p style="font-size: 16px; margin-bottom: 25px;">@notificationMessage</p>

            <button class="login-btn" @onclick="CloseNotification" style="width: 100px;">OK</button>
        </div>
    </div>
}

<div class="modal" style="display: @(showCreateConfirm ? "flex" : "none")">
    <div class="modal-content">
        <span class="modal-close" @onclick="() => showCreateConfirm = false">&times;</span>
        <h2>Category Not Found</h2>
        <p>Would you like to create <b>#@searchTerm</b>?</p>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="login-btn" style="flex:1;" @onclick="NavigateToCreate">Yes, Create</button>
            <button class="login-btn secondary" style="flex:1;" @onclick="() => showCreateConfirm = false">Cancel</button>
        </div>
    </div>
</div>

<div id="auth-overlay" class="auth-overlay" style="display: @(ShowLoginOverlay ? "flex" : "none")">
    <div class="auth-card">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3 style="margin:0;">Welcome</h3><span style="cursor:pointer; font-size:20px;" onclick="document.getElementById('auth-overlay').style.display = 'none'">&times;</span></div>
        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="error-msg">@ErrorMessage</div>
        }
        <div id="login-view"><form action="api/Account/login" method="post"><div class="auth-input-group"><input type="text" name="username" placeholder="Username" required /></div><div class="auth-input-group"><input type="password" name="password" placeholder="Password" required /></div><button type="submit" class="auth-btn">Log In</button></form><div class="auth-switch">Don't have an account? <a onclick="toggleAuthMode()">Register</a></div></div>
        <div id="register-view" class="hidden"><form action="api/Account/register" method="post"><div class="auth-input-group"><input type="email" name="email" placeholder="Email Address" required /></div><div class="auth-input-group"><input type="text" name="username" placeholder="Username" required /></div><div class="auth-input-group"><input type="password" name="password" placeholder="Password" required /></div><button type="submit" class="auth-btn">Sign Up</button></form><div class="auth-switch">Already have an account? <a onclick="toggleAuthMode()">Log In</a></div></div>
    </div>
</div>

<script>
    function showSection(section) {
        document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.settings-content').forEach(el => el.classList.add('hidden'));

        var sidebarId = 'sidebar-' + section;
        var feedId = 'feed-' + section;

        // FIXED: Special case for 'following' section -> Keep Profile Sidebar visible
        if (section === 'following') {
            sidebarId = 'sidebar-profile';
        }

        var sidebar = document.getElementById(sidebarId);
        var feed = document.getElementById(feedId);

        if(sidebar) sidebar.classList.add('active');
        if(feed) feed.classList.add('active');

        document.querySelectorAll('.main-nav a').forEach(el => el.classList.remove('active-link'));

        // Highlight correct nav link (following highlights profile)
        var navSection = section;
        if(section === 'following') navSection = 'profile';

        var navLink = document.getElementById('nav-' + navSection);
        if(navLink) navLink.classList.add('active-link');

        if(section === 'settings') {
            showSettingsForm('profile');
        }

        // Adjust header search visibility and placeholder based on section
        try {
            var headerSearchWrapper = document.getElementById('header-search-wrapper');
            var rightSidebar = document.getElementById('right-sidebar');
            var searchInput = document.getElementById('header-search-input');

            if (section === 'profile' || section === 'following') {
                if(headerSearchWrapper) headerSearchWrapper.style.display = 'flex';
                if(searchInput) searchInput.placeholder = 'Search users...';
                if(rightSidebar) rightSidebar.style.display = 'none';
            } else if (section === 'settings') {
                if(headerSearchWrapper) headerSearchWrapper.style.display = 'none';
                if(rightSidebar) rightSidebar.style.display = 'none';
                showSettingsForm('profile');
            } else {
                if(headerSearchWrapper) headerSearchWrapper.style.display = 'flex';
                if(searchInput) searchInput.placeholder = 'Search posts...';
                if(rightSidebar) rightSidebar.style.display = 'flex';
            }
        } catch (e) { }

        // Notify Blazor about section change
        window.currentSection = section;
    }

    function showSettingsForm(formName) {
        document.querySelectorAll('.settings-content').forEach(el => {
            el.classList.add('hidden');
        });
        var target = document.getElementById('settings-form-' + formName);
        if(target) {
            target.classList.remove('hidden');
        }
        document.querySelectorAll('.sidebar-section .category-link').forEach(el => el.classList.remove('active-setting'));
        var link = document.getElementById('set-link-' + formName);
        if(link) link.classList.add('active-setting');
    }

    function showLoginOverlay() {
        document.getElementById('auth-overlay').style.display = 'flex';
    }

    function toggleAuthMode() {
        var login = document.getElementById('login-view');
        var reg = document.getElementById('register-view');
        if(login.classList.contains('hidden')) {
            login.classList.remove('hidden');
            reg.classList.add('hidden');
        } else {
            login.classList.add('hidden');
            reg.classList.remove('hidden');
        }
    }
</script>

@code {
    [SupplyParameterFromQuery] public string? Error { get; set; }

    // ========== STATE MANAGEMENT ==========
    private string searchTerm = "";
    private string headerSearchTerm = "";
    private string ErrorMessage = "";
    private bool ShowLoginOverlay = false;
    private bool showCreateConfirm = false;
    private string updateStatusMessage = "";
    private bool HasSearchedPosts = false;
    private bool HasSearchedUsers = false;
    private string currentActiveSection = "home";

    // Data collections
    private List<Categories> RecentCategories = new();
    private List<Categories> VerifiedCategories = new();
    private List<Categories> VerifiedCategoriesForRequest = new();
    private List<Categories> FollowedCategories = new();
    private List<Posts> FeedPosts = new();
    private List<Posts> UserPosts = new();
    private List<CategoryAccessRequests> UserAccessRequests = new();
    private List<Posts> PostSearchResults = new();
    private List<Users> UserSearchResults = new();

    // User info
    private Users? currentUser;
    private int selectedCategoryId = 0;
    private string accessRequestReason = "";
    private string accessRequestMessage = "";
    private bool isAccessRequestSuccess = false;

    // Comments/interactions
    private Dictionary<int, bool> _showComments = new();
    private Dictionary<int, List<Comments>> _postComments = new();
    private Dictionary<int, string> _commentDrafts = new();
    private Dictionary<int, int> _carouselIndices = new();

    // Reply Management (NEW)
    private Dictionary<int, bool> _activeReplyBoxes = new(); // Key: CommentId (Parent)
    private Dictionary<int, string> _replyDrafts = new();    // Key: CommentId (Parent)

    // Debugging flag to temporarily render simple post markup instead of PostCard component
    private bool DebugRenderPosts = false;

    // Modals
    private bool showReportModal = false;
    private int reportPostId = 0;
    private string reportReasonSelection = "Spam";
    private string reportReasonDetails = "";
    private bool showNotificationModal = false;
    private string notificationMessage = "";
    private string notificationType = "success";

    // Password change
    private class PasswordChangeModel
    {
        [Required] public string OldPassword { get; set; } = "";
        [Required][StringLength(100, MinimumLength = 6)] public string NewPassword { get; set; } = "";
        [Compare("NewPassword")] public string ConfirmPassword { get; set; } = "";
    }
    private PasswordChangeModel passwordModel = new();
    private string passwordMessage = "";
    private bool isPasswordSuccess = false;

    // ========== LIFECYCLE ==========
    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(Error)) { ErrorMessage = Error; ShowLoginOverlay = true; }
        await LoadUserAndCategories();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload data when returning to this page
        await base.OnParametersSetAsync();
        await LoadUserAndCategories();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Set up visibility change detection to refresh feed when page comes into focus
            try
            {
                await JSRuntime.InvokeVoidAsync("window.addEventListener", "visibilitychange",
                    DotNetObjectReference.Create(this));
            }
            catch { }
        }

        // Check for section changes from JavaScript
        try
        {
            var newSection = await JSRuntime.InvokeAsync<string>("eval", "window.currentSection || 'home'");
            if (newSection != currentActiveSection)
            {
                currentActiveSection = newSection;
                ClearHeaderSearchState();
                StateHasChanged();
            }
        }
        catch { }

        await base.OnAfterRenderAsync(firstRender);
    }

    private void ClearHeaderSearchState()
    {
        headerSearchTerm = "";
        PostSearchResults = new List<Posts>();
        UserSearchResults = new List<Users>();
        HasSearchedPosts = false;
        HasSearchedUsers = false;
    }

    // UPDATED METHOD: Accepts CategoryId and PostId
    private void OnSearchPostClicked(int categoryId, int postId)
    {
        // Clear UI state first
        ClearHeaderSearchState();
        // Navigate to the category page with focusPostId parameter
        Navigation.NavigateTo($"/category/{categoryId}?focusPostId={postId}", true);
    }

    private void OnSearchUserClicked(string? username)
    {
        if (string.IsNullOrEmpty(username)) return;
        ClearHeaderSearchState();
        Navigation.NavigateTo($"/profile/{username}", true);
    }

    // ========== DATA LOADING ==========
    private async Task LoadUserAndCategories()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userPrincipal = authState.User;

            if (userPrincipal.Identity != null && userPrincipal.Identity.IsAuthenticated)
            {
                var userId = userPrincipal.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

                if (string.IsNullOrEmpty(userId))
                {
                    using var scope = ScopeFactory.CreateScope();
                    var userManager = scope.ServiceProvider.GetRequiredService<UserManager<Users>>();
                    var dbUser = await userManager.GetUserAsync(userPrincipal);
                    userId = dbUser?.Id;
                    currentUser = dbUser;
                }
                else if (currentUser == null)
                {
                    using var scope = ScopeFactory.CreateScope();
                    var userManager = scope.ServiceProvider.GetRequiredService<UserManager<Users>>();
                    currentUser = await userManager.FindByIdAsync(userId);
                }

                if (currentUser == null) { ForceLogout(); return; }

                if (!string.IsNullOrEmpty(userId))
                {
                    // Use CategoryService instead of direct DbContext
                    VerifiedCategories = await CategoryService.GetVerifiedCategoriesAsync(5);
                    VerifiedCategoriesForRequest = await CategoryService.GetVerifiedCategoriesAsync(100); // Get all for dropdown
                    RecentCategories = await CategoryService.GetRecentCategoriesAsync(userId, 5);
                    FollowedCategories = await CategoryService.GetFollowedCategoriesAsync(userId);

                    // Use PostService instead of direct DbContext
                    var followedCategoryIds = FollowedCategories.Select(c => c.Id).ToList();
                    if (followedCategoryIds.Any())
                    {
                        FeedPosts = await PostService.GetUserFeedPostsAsync(followedCategoryIds);
                    }
                    else
                    {
                        FeedPosts = new List<Posts>();
                    }
                    
                    UserPosts = await PostService.GetUserPostsAsync(userId);

                    // Access requests still need direct access (no service method yet)
                    using var context = DbFactory.CreateDbContext();
                    UserAccessRequests = await context.CategoryAccessRequests
                        .Where(r => r.UserId == userId)
                        .Include(r => r.Category)
                        .OrderByDescending(r => r.DateCreated)
                        .ToListAsync();
                }
            }
        }
        catch (Exception ex) { Console.WriteLine("Error: " + ex.Message); }
    }

    private async Task RefreshFeed()
    {
        try
        {
            if (string.IsNullOrEmpty(currentUser?.Id)) return;

            // Use CategoryService
            FollowedCategories = await CategoryService.GetFollowedCategoriesAsync(currentUser.Id);
            
            // Use PostService
            var followedCategoryIds = FollowedCategories.Select(c => c.Id).ToList();
            if (followedCategoryIds.Any())
            {
                FeedPosts = await PostService.GetUserFeedPostsAsync(followedCategoryIds);
            }
            else
            {
                FeedPosts = new List<Posts>();
            }

            StateHasChanged();
        }
        catch (Exception ex) { Console.WriteLine($"Error refreshing feed: {ex.Message}"); }
    }

    // ========== CORE ACTIONS ==========
    private void ShowNotification(string message, string type)
    {
        notificationMessage = message;
        notificationType = type;
        showNotificationModal = true;
    }

    private void CloseNotification()
    {
        showNotificationModal = false;
        notificationMessage = "";
    }

    private void OpenReportModal(int postId)
    {
        if (currentUser == null)
        {
            ShowLoginOverlay = true;
            return;
        }
        reportPostId = postId;
        reportReasonSelection = "Spam";
        reportReasonDetails = "";
        showReportModal = true;
    }

    private async Task SubmitReport()
    {
        if (reportPostId == 0 || currentUser == null)
        {
            ShowNotification("Session error. Please refresh and try again.", "error");
            return;
        }

        try
        {
            // Check if user already reported (still need DbContext for this check)
            using var context = DbFactory.CreateDbContext();
            var existingReport = await context.Reports.FirstOrDefaultAsync(r =>
                r.PostID == reportPostId && r.ReporterID == currentUser.Id);

            if (existingReport != null)
            {
                showReportModal = false;
                if (existingReport.Status == "Dismissed")
                    ShowNotification("An Admin has already dismissed your report for this post.", "error");
                else
                    ShowNotification("You have already reported this post.", "error");
                return;
            }

            bool isAlreadyDismissed = await context.Reports.AnyAsync(r =>
                r.PostID == reportPostId && r.Status == "Dismissed");

            string finalReason = reportReasonSelection;
            if (!string.IsNullOrWhiteSpace(reportReasonDetails))
                finalReason = $"{reportReasonSelection}: {reportReasonDetails}";

            var newReport = new Reports
            {
                PostID = reportPostId,
                ReporterID = currentUser.Id,
                Reason = finalReason,
                Status = "Pending",
                DateCreated = DateTime.Now
            };

            // Use PostService
            await PostService.CreateReportAsync(newReport);
            
            showReportModal = false;

            if (isAlreadyDismissed)
                ShowNotification("Report submitted, but this content has already been reviewed and dismissed by admins.", "info");
            else
                ShowNotification("Report submitted successfully.", "success");
        }
        catch (Exception ex)
        {
            ShowNotification("Error sending report: " + ex.Message, "error");
        }
    }

    private async Task ToggleLike(int postId)
    {
        if (currentUser == null) { ShowLoginOverlay = true; return; }
        try
        {
            // Use PostService
            await PostService.ToggleLikeAsync(postId, currentUser.Id);

            // Update local state
            var feedPost = FeedPosts.FirstOrDefault(p => p.Id == postId);
            var userPost = UserPosts.FirstOrDefault(p => p.Id == postId);

            if (feedPost != null)
            {
                // Reload likes for this post
                using var context = DbFactory.CreateDbContext();
                feedPost.Likes = await context.PostLikes.Where(l => l.PostID == postId).ToListAsync();
            }

            if (userPost != null && !object.ReferenceEquals(userPost, feedPost))
            {
                using var context = DbFactory.CreateDbContext();
                userPost.Likes = await context.PostLikes.Where(l => l.PostID == postId).ToListAsync();
            }

            StateHasChanged();
        }
        catch (Exception ex) { Console.WriteLine($"Error toggling like: {ex.Message}"); }
    }

    private async Task ToggleComments(int postId)
    {
        if (!_showComments.ContainsKey(postId)) _showComments[postId] = false;
        _showComments[postId] = !_showComments[postId];

        if (_showComments[postId])
        {
            if (!_postComments.ContainsKey(postId) || _postComments[postId] == null)
            {
                try
                {
                    // Use PostService
                    _postComments[postId] = await PostService.GetPostCommentsAsync(postId);
                }
                catch (Exception ex) { Console.WriteLine("Error loading comments: " + ex.Message); }
            }
        }
        StateHasChanged();
    }

    // ========== REPLY HANDLERS (NEW) ==========
    private void ToggleReplyBox(int commentId)
    {
        if (!_activeReplyBoxes.ContainsKey(commentId))
            _activeReplyBoxes[commentId] = false;

        _activeReplyBoxes[commentId] = !_activeReplyBoxes[commentId];

        // Initialize draft if it doesn't exist
        if (!_replyDrafts.ContainsKey(commentId))
            _replyDrafts[commentId] = "";

        StateHasChanged();
    }

    private void UpdateReplyDraft(PostCard.ReplyDraftEventArgs args)
    {
        if (args.Content != null)
        {
            _replyDrafts[args.ParentCommentId] = args.Content;
        }
    }

    private async Task SubmitReply(PostCard.SubmitReplyEventArgs args)
    {
        if (currentUser == null) { ShowLoginOverlay = true; return; }

        // Validate draft
        if (!_replyDrafts.ContainsKey(args.ParentCommentId) || string.IsNullOrWhiteSpace(_replyDrafts[args.ParentCommentId]))
            return;

        try
        {
            var newComment = new Comments
            {
                PostID = args.PostId,
                UserID = currentUser.Id,
                Content = _replyDrafts[args.ParentCommentId],
                ParentCommentID = args.ParentCommentId,
                DateCreated = DateTime.Now,
                DateUpdated = DateTime.Now,
                CreatedBy = currentUser.Id
            };

            // Use PostService
            await PostService.CreateCommentAsync(newComment);

            // Cleanup UI
            _replyDrafts[args.ParentCommentId] = "";
            _activeReplyBoxes[args.ParentCommentId] = false;

            // Update local state to show the new reply immediately
            newComment.User = currentUser;

            if (!_postComments.ContainsKey(args.PostId))
                _postComments[args.PostId] = new List<Comments>();

            _postComments[args.PostId].Add(newComment);

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error posting reply: " + ex.Message);
        }
    }

    // ========== EVENT HANDLERS ==========
    private async Task HandleHeaderSearch(KeyboardEventArgs? e = null)
    {
        // Query the latest section directly from JS at the time of the search
        string section = "home";
        try
        {
            section = await JSRuntime.InvokeAsync<string>("eval", "window.currentSection || 'home'");
        }
        catch { section = currentActiveSection ?? "home"; }

        if (section == "profile")
        {
            await HandleUserSearch();
        }
        else if (section == "settings")
        {
            // Do nothing on settings page - searches disabled
            return;
        }
        else
        {
            await HandlePostSearch();
        }
    }

    private async Task HandlePostSearch()
    {
        if (string.IsNullOrWhiteSpace(headerSearchTerm))
        {
            PostSearchResults = new();
            HasSearchedPosts = false;
            StateHasChanged();
            return;
        }

        HasSearchedPosts = true;

        try
        {
            using var context = DbFactory.CreateDbContext();
            var searchTerm = headerSearchTerm.ToLower();

            PostSearchResults = await context.Posts
                .Where(p => p.Content.ToLower().Contains(searchTerm) ||
                           p.User.UserName.ToLower().Contains(searchTerm))
                .Include(p => p.User)
                .Include(p => p.Category)
                .Include(p => p.Media)
                .Include(p => p.Likes)
                .OrderByDescending(p => p.DateCreated)
                .Take(10)
                .ToListAsync();

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error searching posts: {ex.Message}");
        }
    }

    private async Task HandleUserSearch()
    {
        if (string.IsNullOrWhiteSpace(headerSearchTerm))
        {
            UserSearchResults = new();
            HasSearchedUsers = false;
            StateHasChanged();
            return;
        }

        HasSearchedUsers = true;
        try
        {
            using var context = DbFactory.CreateDbContext();
            UserSearchResults = await context.Users
                .Where(u => u.UserName.ToLower().Contains(headerSearchTerm.ToLower()) ||
                           u.DisplayName.ToLower().Contains(headerSearchTerm.ToLower()))
                .OrderBy(u => u.DisplayName ?? u.UserName)
                .Take(10)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error searching users: {ex.Message}");
        }
    }

    private async Task HandleCategorySearch()
    {
        if (string.IsNullOrWhiteSpace(searchTerm)) return;

        // Trim search term
        var term = searchTerm.Trim();

        // Use CategoryService
        var cat = await CategoryService.GetCategoryByNameAsync(term);

        if (cat != null)
        {
            // Found exact match -> Go to it
            Navigation.NavigateTo($"/category/{cat.Id}", true);
        }
        else
        {
            showCreateConfirm = true;
        }
    }

    private void NavigateToCreate() => Navigation.NavigateTo($"/categories/create?name={searchTerm}");

    private async Task UpdateProfile()
    {
        if (currentUser == null) return;
        try
        {
            using var scope = ScopeFactory.CreateScope();
            var userManager = scope.ServiceProvider.GetRequiredService<UserManager<Users>>();
            var userToUpdate = await userManager.FindByIdAsync(currentUser.Id);
            if (userToUpdate != null)
            {
                userToUpdate.DisplayName = currentUser.DisplayName;
                userToUpdate.Bio = currentUser.Bio;

                // --- Update profile image in DB ---
                userToUpdate.ProfileImage = currentUser.ProfileImage;

                var result = await userManager.UpdateAsync(userToUpdate);
                if (result.Succeeded)
                {
                    updateStatusMessage = "Profile updated successfully!";
                    currentUser = userToUpdate;

                    // --- FORCE UPDATE LOCAL POST LISTS TO REFLECT NEW IMAGE ---
                    if (UserPosts != null)
                    {
                        foreach (var post in UserPosts)
                        {
                            if (post.User != null)
                            {
                                post.User.ProfileImage = currentUser.ProfileImage;
                                post.User.DisplayName = currentUser.DisplayName;
                            }
                        }
                    }

                    if (FeedPosts != null)
                    {
                        foreach (var post in FeedPosts)
                        {
                            if (post.UserId == currentUser.Id && post.User != null)
                            {
                                post.User.ProfileImage = currentUser.ProfileImage;
                                post.User.DisplayName = currentUser.DisplayName;
                            }
                        }
                    }
                    // --------------------------------------------------------

                    StateHasChanged();
                }
                else
                {
                    updateStatusMessage = "Error: " + string.Join(", ", result.Errors.Select(e => e.Description));
                }
            }
        }
        catch (Exception ex) { updateStatusMessage = "Error updating: " + ex.Message; }
    }

    private async Task HandleProfileImageSelected(InputFileChangeEventArgs e)
    {
        if (currentUser == null)
        {
            ShowLoginOverlay = true;
            return;
        }

        var file = e.File;
        // Limit max file size to 5MB to prevent crashes
        long maxFileSize = 1024 * 1024 * 5;

        try
        {
            // Resize image to 512x512 pixels to keep DB size manageable
            // This is crucial when storing images as Base64 in the database
            var resizedFile = await file.RequestImageFileAsync(file.ContentType, 512, 512);

            var buffer = new byte[resizedFile.Size];
            await resizedFile.OpenReadStream(maxFileSize).ReadAsync(buffer);
            var base64 = Convert.ToBase64String(buffer);

            // Update the UI immediately with the new Base64 string
            // This does NOT save to DB yet; user must click "Save Changes"
            currentUser.ProfileImage = $"data:{file.ContentType};base64,{base64}";

            updateStatusMessage = "Photo selected. Click 'Save Changes' to apply.";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            updateStatusMessage = "Error: " + ex.Message;
        }
    }

    private async Task HandlePasswordChange() { }

    private async Task UnfollowCategory(int categoryId)
    {
        if (string.IsNullOrEmpty(currentUser?.Id)) return;
        try
        {
            // Use CategoryService
            await CategoryService.ToggleFollowAsync(currentUser.Id, categoryId);
            await RefreshFeed();
        }
        catch (Exception ex) { Console.WriteLine(ex.Message); }
    }

    private void UpdateCommentDraft(PostCard.CommentDraftEventArgs args)
    {
        if (args.Content != null)
        {
            _commentDrafts[args.PostId] = args.Content;
        }
    }

    private async Task SubmitComment(int postId)
    {
        if (currentUser == null) { ShowLoginOverlay = true; return; }
        if (!_commentDrafts.ContainsKey(postId) || string.IsNullOrWhiteSpace(_commentDrafts[postId])) return;

        var content = _commentDrafts[postId];

        try
        {
            var newComment = new Comments
            {
                PostID = postId,
                UserID = currentUser.Id,
                Content = content,
                DateCreated = DateTime.Now,
                DateUpdated = DateTime.Now,
                CreatedBy = currentUser.Id
            };

            // Use PostService
            await PostService.CreateCommentAsync(newComment);

            _commentDrafts[postId] = "";
            newComment.User = currentUser;
            if (!_postComments.ContainsKey(postId)) _postComments[postId] = new List<Comments>();
            _postComments[postId].Add(newComment);
            StateHasChanged();
        }
        catch (Exception ex) { Console.WriteLine("Error posting comment: " + ex.Message); }
    }

    private void UpdateCarouselIndex(PostCard.CarouselEventArgs args)
    {
        _carouselIndices[args.PostId] = args.Index;
        StateHasChanged();
    }

    private void ForceLogout() => Navigation.NavigateTo("/api/Account/logout", true);

    private void NavigateToCategory(int id) => Navigation.NavigateTo($"/category/{id}");

    private void NavigateToAdmin() { Navigation.NavigateTo("admin", forceLoad: true); }

    private async Task HandleAccessRequest()
    {
        if (currentUser == null)
        {
            ShowLoginOverlay = true;
            return;
        }

        if (selectedCategoryId == 0)
        {
            ShowNotification("Please select a category.", "error");
            return;
        }

        if (string.IsNullOrWhiteSpace(accessRequestReason))
        {
            ShowNotification("Please provide a reason for the request.", "error");
            return;
        }

        try
        {
            // Check for existing request (still need DbContext for this specific check)
            using var context = DbFactory.CreateDbContext();
            var existingRequest = await context.CategoryAccessRequests
                .FirstOrDefaultAsync(r => r.UserId == currentUser.Id && r.CategoryId == selectedCategoryId);

            if (existingRequest != null)
            {
                ShowNotification("You have already submitted a request for this category.", "error");
                return;
            }

            var newRequest = new CategoryAccessRequests
            {
                UserId = currentUser.Id,
                CategoryId = selectedCategoryId,
                Reason = accessRequestReason,
                Status = "Pending",
                DateCreated = DateTime.Now
            };

            // Use CategoryService
            await CategoryService.CreateAccessRequestAsync(newRequest);

            accessRequestMessage = "Request submitted successfully!";
            isAccessRequestSuccess = true;
            StateHasChanged();

            await LoadUserAndCategories();
        }
        catch (Exception ex)
        {
            accessRequestMessage = "Error submitting request: " + ex.Message;
            isAccessRequestSuccess = false;
        }
    }

    // --- NEW METHOD ---
    private void RefreshPage()
    {
        Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
    }
}