@page "/"
@rendermode InteractiveServer
@using SoSuSaFsd.Data
@using SoSuSaFsd.Domain
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using System.ComponentModel.DataAnnotations
@using System.IO
@inject IDbContextFactory<SoSuSaFsdContext> DbFactory
@inject IServiceScopeFactory ScopeFactory
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider
@inject IWebHostEnvironment Environment

<PageTitle>SoSuSa - Home</PageTitle>

<style>
    /* --- GLOBAL STYLES --- */
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #ffffff;
        margin: 0;
        color: #333;
    }

    a {
        text-decoration: none;
        color: #333;
        cursor: pointer;
    }

    ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
    }

    hr {
        border: 0;
        border-top: 1px solid #ddd;
        margin: 15px 0;
    }

    /* --- HEADER --- */
    .site-header {
        background-color: #ffffff;
        border-bottom: 2px solid #333;
        padding: 10px 0;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 1000;
        height: 62px;
        box-sizing: border-box;
    }

    .header-container {
        width: 95%;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 100%;
    }

    .logo-area {
        display: flex;
        align-items: center;
        text-decoration: none;
        cursor: pointer;
    }

    .logo-icon {
        width: 40px;
        height: 40px;
        background-color: #333;
        color: white;
        border-radius: 50% 50% 50% 4px;
        margin-right: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        box-shadow: 2px 2px 0px #999;
    }

    .logo-text {
        font-size: 32px;
        font-weight: 700;
        color: #333;
        letter-spacing: -1px;
    }

    .main-nav {
        display: flex;
        gap: 30px;
    }

        .main-nav a {
            font-size: 18px;
            color: #555;
            font-weight: 500;
            cursor: pointer;
        }

            .main-nav a:hover, .main-nav a.active-link {
                color: #000;
                border-bottom: 2px solid #333;
            }

    .header-right {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .search-bar {
        padding: 8px 15px;
        font-size: 15px;
        border: 1px solid #ccc;
        border-radius: 20px;
        width: 200px;
        background-color: #f5f5f5;
    }

    .login-btn {
        background-color: #333;
        color: white;
        padding: 8px 20px;
        border: none;
        border-radius: 20px;
        font-size: 15px;
        cursor: pointer;
        font-weight: bold;
        text-decoration: none;
        display: inline-block;
    }

        .login-btn:hover {
            background-color: #000;
        }

        .login-btn.secondary {
            background-color: #fff;
            color: #333;
            border: 1px solid #ccc;
        }

    .admin-btn {
        background-color: #dc3545;
        color: white;
        padding: 8px 20px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 15px;
        border: none;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }

        .admin-btn:hover {
            background-color: #bb2d3b;
            color: white;
        }

    /* --- LAYOUT --- */
    .main-layout {
        display: flex;
        justify-content: center;
        width: 100%;
        max-width: 1100px;
        margin: 0 auto 20px auto;
        min-height: 80vh;
        gap: 0;
        margin-top: 62px;
    }

    /* --- SIDEBAR --- */
    .sidebar {
        width: 240px;
        position: sticky;
        top: 60px;
        height: calc(100vh - 60px);
        display: flex;
        flex-direction: column;
        padding-top: 22px;
        box-sizing: border-box;
        overflow-y: auto;
    }

    .sidebar-left {
        border-right: 1px solid #ddd;
        padding-right: 20px;
    }

    .sidebar-right {
        border-left: 1px solid #ddd;
        padding-left: 20px;
    }

    .sidebar-section {
        margin-bottom: 20px;
        padding-bottom: 10px;
    }

        .sidebar-section h3 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            font-weight: bold;
            text-transform: none;
        }

    .category-link {
        font-size: 16px;
        color: #555;
        display: flex;
        align-items: center;
        padding: 5px 0;
        transition: color 0.2s;
        cursor: pointer;
    }

        .category-link:hover {
            color: #000;
            text-decoration: underline;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        .category-link.active-setting {
            font-weight: bold;
            color: #000;
        }

    .hashtag {
        color: #999;
        font-weight: normal;
        margin-right: 8px;
    }

    .sidebar-footer {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #ddd;
    }

    .category-search-container {
        display: flex;
        gap: 10px;
        align-items: center;
    }

        .category-search-container input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
        }

    .create-cat-btn {
        background-color: #333;
        color: white;
        border: none;
        width: 34px;
        height: 34px;
        border-radius: 4px;
        font-size: 20px;
        line-height: 1;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

        .create-cat-btn:hover {
            background-color: #000;
        }

    /* --- FEED & POSTS --- */
    .feed-area {
        width: 600px;
        flex-grow: 0;
        padding-top: 20px;
        margin: 0 40px;
    }

    .feed-header {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        margin-bottom: 10px;
    }

    .feed-header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }

    .page-title {
        font-size: 32px;
        font-weight: 800;
        color: #222;
        margin: 0;
    }

    .create-post-btn {
        background-color: #e0e0e0;
        color: #333;
        padding: 6px 12px;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-weight: normal;
        font-size: 13px;
        cursor: pointer;
        width: auto;
        display: inline-block;
    }

        .create-post-btn:hover {
            background-color: #d0d0d0;
            border-color: #bbb;
        }

    .post-card {
        background-color: #fff;
        padding: 0;
        margin-bottom: 20px;
        border: 1px solid #e1e1e1;
        border-radius: 8px;
        overflow: hidden;
    }

    .post-header {
        display: flex;
        align-items: center;
        padding: 15px;
    }

    .post-avatar {
        width: 48px;
        height: 48px;
        background-color: #ddd;
        border-radius: 50%;
        margin-right: 15px;
        object-fit: cover;
    }

    .post-meta div {
        font-size: 15px;
        color: #222;
    }

    .post-category-tag {
        color: #666;
        font-size: 13px;
        margin-top: 2px;
    }

        .post-category-tag a {
            color: #333;
            font-weight: bold;
            text-decoration: none;
        }

    .post-content {
        font-size: 16px;
        color: #111;
        line-height: 1.6;
        padding: 5px 15px 20px 15px;
    }

    .post-actions {
        border-top: 1px solid #f0f0f0;
        display: flex;
    }

    .action-btn {
        flex-grow: 1;
        background: none;
        border: none;
        font-size: 14px;
        color: #666;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 0;
        transition: background-color 0.2s;
    }

        .action-btn:hover {
            background-color: #f9f9f9;
            color: #333;
        }

    .report-btn:hover {
        background-color: #fff0f0;
        color: #d9534f;
    }

    /* --- VERIFIED BADGE ALIGNMENT FIX --- */
    .verified-badge {
        color: #1da1f2;
        font-size: 14px;
        margin-left: 5px;
        position: relative;
        top: 3px;
    }

    /* --- CAROUSEL STYLES --- */
    .carousel-container {
        position: relative;
        width: 100%;
        height: 400px;
        overflow: hidden;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .carousel-media {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        display: block;
    }

    .carousel-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.5);
        color: white;
        border: none;
        font-size: 24px;
        padding: 10px 15px;
        cursor: pointer;
        z-index: 10;
        transition: background 0.2s;
        border-radius: 4px;
    }

        .carousel-btn:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .carousel-btn.prev {
            left: 10px;
        }

        .carousel-btn.next {
            right: 10px;
        }

    .carousel-counter {
        position: absolute;
        bottom: 15px;
        right: 15px;
        background: rgba(0,0,0,0.6);
        color: white;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 13px;
        font-weight: bold;
    }

    /* --- PROFILE & MODALS --- */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background-color: #fff;
        margin: auto;
        padding: 25px;
        border: none;
        width: 90%;
        max-width: 450px;
        border-radius: 12px;
        position: relative;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .modal-close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 20px;
    }

    .profile-card {
        text-align: center;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
    }

    .profile-avatar-large {
        width: 120px;
        height: 120px;
        background-color: #ddd;
        border-radius: 50%;
        margin: 0 auto 15px auto;
        object-fit: cover;
    }

    .profile-name {
        font-size: 24px;
        font-weight: 800;
        margin: 0 0 5px 0;
        color: #222;
    }

    .profile-handle {
        font-size: 16px;
        color: #666;
        margin: 0 0 15px 0;
    }

    .profile-bio {
        font-size: 15px;
        color: #444;
        line-height: 1.4;
        margin-bottom: 20px;
        padding: 0 10px;
    }

    .profile-stats {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
        padding: 10px 0;
        border-top: 1px solid #f5f5f5;
        border-bottom: 1px solid #f5f5f5;
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        cursor: pointer;
        transition: background 0.2s;
        border-radius: 8px;
        padding: 5px 10px;
    }

        .stat-item:hover {
            background-color: #f5f5f5;
        }

    .edit-profile-btn {
        background-color: #fff;
        border: 1px solid #ccc;
        color: #333;
        padding: 8px 20px;
        border-radius: 20px;
        font-weight: bold;
        cursor: pointer;
        width: 100%;
        transition: background-color 0.2s;
    }

    .settings-form-group {
        margin-bottom: 20px;
    }

        .settings-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .settings-form-group input, .settings-form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

    .auth-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(5px);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .auth-card {
        background-color: #fff;
        width: 90%;
        max-width: 400px;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        text-align: center;
        border: 1px solid #eee;
    }

    .auth-header {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 20px;
        color: #333;
    }

    .auth-input-group {
        margin-bottom: 15px;
        text-align: left;
    }

        .auth-input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            box-sizing: border-box;
            background-color: #f9f9f9;
        }

    .auth-btn {
        width: 100%;
        padding: 12px;
        background-color: #333;
        color: white;
        border: none;
        border-radius: 20px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 10px;
    }

    .auth-switch {
        margin-top: 20px;
        font-size: 14px;
        color: #666;
    }

    .hidden {
        display: none;
    }

    .section-view {
        display: none;
    }

        .section-view.active {
            display: block;
        }

    .error-msg {
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 4px;
        font-size: 14px;
        display: block;
        width: 100%;
        box-sizing: border-box;
    }

    .success-msg {
        color: #155724;
        background-color: #d4edda;
        border-color: #c3e6cb;
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 4px;
        font-size: 14px;
        display: block;
        width: 100%;
        box-sizing: border-box;
    }

    .text-danger {
        color: #dc3545;
        font-size: 13px;
        display: block;
        margin-top: 5px;
    }

    /* --- FOLLOWING LIST STYLES --- */
    .following-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
    }

    .following-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        background: #fff;
        transition: border-color 0.2s;
    }

        .following-card:hover {
            border-color: #333;
        }

        .following-card h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #333;
        }

    /* --- IMAGE CROPPER MODAL STYLES --- */
    .crop-container {
        width: 250px;
        height: 250px;
        border-radius: 50%;
        overflow: hidden;
        border: 2px solid #333;
        margin: 20px auto;
        position: relative;
        cursor: grab;
        background-color: #eee;
    }

        .crop-container:active {
            cursor: grabbing;
        }

    .crop-image {
        position: absolute;
        transform-origin: center center;
        user-select: none;
        pointer-events: none;
    }

    .slider-container {
        width: 80%;
        margin: 10px auto;
        text-align: center;
    }

        .slider-container input {
            width: 100%;
        }
</style>

<header class="site-header">
    <div class="header-container">
        <div class="logo-area" onclick="showSection('home')">
            <div class="logo-icon"><i class="fas fa-check"></i></div>
            <span class="logo-text">SoSuSa</span>
        </div>
        <nav class="main-nav">
            <a onclick="showSection('home')" id="nav-home" class="active-link">Home</a>
            <a onclick="showSection('profile')" id="nav-profile">Profile</a>
            <a onclick="showSection('settings')" id="nav-settings">Settings</a>
        </nav>
        <div class="header-right">
            <form action="#">
                <input type="text" id="header-search-input" class="search-bar" placeholder="Search posts...">
            </form>
            <AuthorizeView>
                <Authorized>
                    <AuthorizeView Roles="Admin" Context="innerContext">
                        <button class="admin-btn" style="margin-right: 10px;" @onclick="NavigateToAdmin">Admin Panel</button>
                    </AuthorizeView>
                    <button class="login-btn" @onclick="ForceLogout">Logout</button>
                </Authorized>
                <NotAuthorized>
                    <button class="login-btn" onclick="showLoginOverlay()">Login</button>
                </NotAuthorized>
            </AuthorizeView>
        </div>
    </div>
</header>

<div class="main-layout">
    <aside class="sidebar sidebar-left">
        <div id="sidebar-home" class="section-view active">
            <div class="sidebar-section">
                <h3>Recently Created</h3>
                <ul class="category-list">
                    @if (RecentCategories != null && RecentCategories.Any())
                    {
                        @foreach (var cat in RecentCategories)
                        {
                            <li>
                                <a class="category-link" href="#" @onclick:preventDefault @onclick='@(() => NavigateToCategory(cat.Id))'>
                                    <span class="hashtag">#</span> @cat.CategoryName
                                    @if (cat.IsVerified)
                                    {
                                        <i class="fas fa-check-circle verified-badge" title="Verified"></i>
                                    }
                                </a>
                            </li>
                        }
                    }
                    else
                    {
                        <AuthorizeView>
                            <Authorized><li>You haven't created any categories yet.</li></Authorized>
                            <NotAuthorized><li>Login to see your categories.</li></NotAuthorized>
                        </AuthorizeView>
                    }
                </ul>
                <hr />
            </div>
            <div class="sidebar-footer">
                <div class="category-search-container">
                    <input type="text" placeholder="Find category..." @bind="searchTerm" @bind:event="oninput" />
                    <button type="button" class="create-cat-btn" title="Create New Category" @onclick="HandleCategorySearch">+</button>
                </div>
            </div>
        </div>

        <div id="sidebar-profile" class="section-view">
            <div class="profile-card">
                @* SIDEBAR PROFILE PICTURE *@
                <div class="profile-avatar-large" style="background-image: url('@(currentUser?.ProfileImage ?? "")');"></div>
                <h2 class="profile-name">@(currentUser?.UserName ?? "Guest")</h2>
                <p class="profile-handle">@@@(currentUser?.UserName?.ToLower() ?? "guest")</p>
                <p class="profile-bio">@(currentUser?.Bio ?? "No bio available")</p>
                <div class="profile-stats">
                    <div class="stat-item" onclick="showSection('profile')"><b>@UserPosts.Count</b><span>Posts</span></div>
                    <div class="stat-item" onclick="showSection('following')"><b>@FollowedCategories.Count</b><span>Following</span></div>
                </div>
                <button class="edit-profile-btn" onclick="showSection('settings')">Edit Profile</button>
            </div>
        </div>

        <div id="sidebar-settings" class="section-view">
            <div class="sidebar-section">
                <h3>Account</h3>
                <ul class="category-list">
                    <li><a onclick="showSettingsForm('profile')" id="set-link-profile" class="category-link active-setting">Edit Profile</a></li>
                    <li><a onclick="showSettingsForm('password')" id="set-link-password" class="category-link">Change Password</a></li>
                    <li><a onclick="showSettingsForm('verification')" id="set-link-verification" class="category-link">Request Verification</a></li>
                    <li><a href="#" class="category-link" style="color:red;">Deactivate Account</a></li>
                </ul>
            </div>
        </div>
    </aside>

    <main class="feed-area">
        @* --- HOME FEED --- *@
        <div id="feed-home" class="section-view active">
            <div class="feed-header">
                <div class="feed-header-top">
                    <h1 class="page-title">Home</h1>
                    <button class="create-post-btn" onclick="alert('Join a category to post!')">Create Post</button>
                </div>
            </div>
            <hr />

            @if (FeedPosts != null && FeedPosts.Any())
            {
                @foreach (var post in FeedPosts)
                {
                    <div class="post-card">
                        <div class="post-header">
                            <div class="post-avatar" style="background-image: url('@(post.User?.ProfileImage ?? "")');"></div>
                            <div>
                                <b>@(post.User?.UserName ?? "User")</b>
                                <div class="post-meta">
                                    <span style="font-size: 12px; color: #888;">@post.DateCreated.ToString("MMM dd, yyyy • HH:mm")</span>
                                    <div class="post-category-tag">
                                        Posted in <a href="#" @onclick:preventDefault @onclick='@(() => NavigateToCategory(post.CategoryId))'>
                                            #@post.Category?.CategoryName
                                            @if (post.Category?.IsVerified == true)
                                            {
                                                <i class="fas fa-check-circle verified-badge" style="font-size:12px;" title="Verified"></i>
                                            }
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="post-content">
                            @post.Content
                        </div>

                        @if (post.Media != null && post.Media.Any())
                        {
                            var mediaList = post.Media.ToList();
                            var totalMedia = mediaList.Count;
                            var currentIndex = GetCurrentIndex(post.Id);
                            var activeMedia = mediaList[currentIndex];

                            <div class="carousel-container">
                                @if (totalMedia > 1)
                                {
                                    <button class="carousel-btn prev" @onclick="() => PrevSlide(post.Id, totalMedia)">&#10094;</button>
                                }

                                @if (activeMedia.MediaType == "Video")
                                {
                                    <video controls class="carousel-media" src="@activeMedia.MediaPath" @key="activeMedia.MediaPath">
                                        Your browser does not support the video tag.
                                    </video>
                                }
                                else
                                {
                                    <img class="carousel-media" src="@activeMedia.MediaPath" alt="Post Media" @key="activeMedia.MediaPath" />
                                }

                                @if (totalMedia > 1)
                                {
                                    <button class="carousel-btn next" @onclick="() => NextSlide(post.Id, totalMedia)">&#10095;</button>
                                    <div class="carousel-counter">@(currentIndex + 1) / @totalMedia</div>
                                }
                            </div>
                        }

                        <div class="post-actions">
                            @* --- LIKE BUTTON --- *@
                            <button class="action-btn" @onclick="() => ToggleLike(post.Id)">
                                @{
                                    var isLiked = post.Likes.Any(l => l.UserID == currentUser?.Id);
                                    var likeCount = post.Likes.Count;
                                }

                                @if (isLiked)
                                {
                                    <i class="fas fa-heart" style="color: #e0245e; margin-right: 5px;"></i>
                                }
                                else
                                {
                                    <i class="far fa-heart" style="margin-right: 5px;"></i>
                                }

                                @if (likeCount > 0)
                                {
                                    <span>@likeCount</span>
                                }
                                else
                                {
                                    <span>Like</span>
                                }
                            </button>
                            @* ------------------ *@

                            <button class="action-btn"><i class="far fa-comment"></i> Comment</button>
                            <button class="action-btn"><i class="far fa-share-square"></i> Share</button>
                            <button class="action-btn report-btn" onclick="openReportModal()"><i class="far fa-flag"></i> Report</button>
                        </div>
                    </div>
                }
            }
            else
            {
                <div style="text-align: center; color: #666; margin-top: 40px; padding: 20px;">
                    <h3>Your feed is empty.</h3>
                    <p>Follow categories to see posts here!</p>
                </div>
            }
        </div>

        @* --- PROFILE FEED --- *@
        <div id="feed-profile" class="section-view">
            <h1 class="page-title">My Posts</h1>
            <hr />
            @if (UserPosts != null && UserPosts.Any())
            {
                @foreach (var post in UserPosts)
                {
                    <div class="post-card">
                        <div class="post-header">
                            <div class="post-avatar" style="background-image: url('@(post.User?.ProfileImage ?? "")');"></div>
                            <div>
                                <b>@(post.User?.UserName ?? "User")</b>
                                <div class="post-meta">
                                    <span style="font-size: 12px; color: #888;">@post.DateCreated.ToString("MMM dd, yyyy • HH:mm")</span>
                                    <div class="post-category-tag">
                                        Posted in <a href="#" @onclick:preventDefault @onclick='@(() => NavigateToCategory(post.CategoryId))'>
                                            #@post.Category?.CategoryName
                                            @if (post.Category?.IsVerified == true)
                                            {
                                                <i class="fas fa-check-circle verified-badge" style="font-size:12px;" title="Verified"></i>
                                            }
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="post-content">
                            @post.Content
                        </div>
                        @if (post.Media != null && post.Media.Any())
                        {
                            var mediaList = post.Media.ToList();
                            var totalMedia = mediaList.Count;
                            var currentIndex = GetCurrentIndex(post.Id);
                            var activeMedia = mediaList[currentIndex];
                            <div class="carousel-container">
                                @if (totalMedia > 1)
                                {
                                    <button class="carousel-btn prev" @onclick="() => PrevSlide(post.Id, totalMedia)">&#10094;</button>
                                }
                                @if (activeMedia.MediaType == "Video")
                                {
                                    <video controls class="carousel-media" src="@activeMedia.MediaPath" @key="activeMedia.MediaPath"></video>
                                }
                                else
                                {
                                    <img class="carousel-media" src="@activeMedia.MediaPath" alt="Post Media" @key="activeMedia.MediaPath" />
                                }
                                @if (totalMedia > 1)
                                {
                                    <button class="carousel-btn next" @onclick="() => NextSlide(post.Id, totalMedia)">&#10095;</button>
                                }
                            </div>
                        }
                        <div class="post-actions">
                            @* --- LIKE BUTTON (Profile Feed) --- *@
                            <button class="action-btn" @onclick="() => ToggleLike(post.Id)">
                                @{
                                    var isLiked = post.Likes.Any(l => l.UserID == currentUser?.Id);
                                    var likeCount = post.Likes.Count;
                                }

                                @if (isLiked)
                                {
                                    <i class="fas fa-heart" style="color: #e0245e; margin-right: 5px;"></i>
                                }
                                else
                                {
                                    <i class="far fa-heart" style="margin-right: 5px;"></i>
                                }

                                @if (likeCount > 0)
                                {
                                    <span>@likeCount</span>
                                }
                                else
                                {
                                    <span>Like</span>
                                }
                            </button>
                            @* --------------------------------- *@
                            <button class="action-btn"><i class="far fa-comment"></i> Comment</button>
                            <button class="action-btn"><i class="far fa-share-square"></i> Share</button>
                        </div>
                    </div>
                }
            }
            else
            {
                <p style="text-align:center; color:#666;">No posts yet.</p>
            }
        </div>

        @* --- FOLLOWING FEED --- *@
        <div id="feed-following" class="section-view">
            <h1 class="page-title">Following</h1>
            <hr />
            @if (FollowedCategories != null && FollowedCategories.Any())
            {
                <div class="following-grid">
                    @foreach (var cat in FollowedCategories)
                    {
                        <div class="following-card">
                            <h3>
                                #@cat.CategoryName
                                @if (cat.IsVerified)
                                {
                                    <i class="fas fa-check-circle verified-badge" title="Verified"></i>
                                }
                            </h3>
                            <button class="login-btn secondary" @onclick="() => UnfollowCategory(cat.Id)">Unfollow</button>
                        </div>
                    }
                </div>
            }
            else
            {
                <p style="text-align:center; color:#666; margin-top:30px;">You are not following any categories.</p>
            }
        </div>

        @* --- SETTINGS AREA --- *@
        <div id="feed-settings" class="section-view">
            <div id="settings-form-profile" class="settings-content active">
                <h1 class="page-title">Edit Profile</h1>
                <hr />
                <div class="post-card" style="padding: 20px;">
                    @if (currentUser != null)
                    {
                        <form @onsubmit="UpdateProfile">
                            <div class="settings-form-group" style="display:flex; flex-direction:column; align-items:center;">
                                <div style="width: 100px; height: 100px; border-radius: 50%; background-color: #ddd; background-size: cover; background-position: center; background-image: url('@(currentUser.ProfileImage ?? "")'); margin-bottom: 10px;"></div>
                                <label class="login-btn secondary" style="cursor: pointer; font-weight:normal; font-size:13px; padding: 5px 15px; position: relative; overflow: hidden;">
                                    Change Photo
                                    <InputFile OnChange="HandleProfileImageSelected"
                                               accept=".jpg,.jpeg,.png"
                                               style="position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer;" />
                                </label>
                            </div>

                            <div class="settings-form-group">
                                <label>Display Name</label>
                                <input type="text" @bind="currentUser.DisplayName">
                            </div>
                            <div class="settings-form-group">
                                <label>Bio</label>
                                <textarea rows="4" @bind="currentUser.Bio"></textarea>
                            </div>

                            @if (!string.IsNullOrEmpty(updateStatusMessage))
                            {
                                @if (updateStatusMessage.Contains("Error"))
                                {
                                    <div class="error-msg">@updateStatusMessage</div>
                                }
                                else
                                {
                                    <div class="success-msg">@updateStatusMessage</div>
                                }
                            }

                            <button type="submit" class="login-btn">Save Changes</button>
                        </form>
                    }
                    else
                    {
                        <p>Please login to edit profile.</p>
                    }
                </div>
            </div>

            <div id="settings-form-password" class="settings-content hidden">
                <h1 class="page-title">Change Password</h1>
                <hr />
                <div class="post-card" style="padding: 20px;">
                    <EditForm Model="passwordModel" OnValidSubmit="HandlePasswordChange" FormName="passwordChangeForm">
                        <DataAnnotationsValidator />
                        <div class="settings-form-group"><label>Current Password</label><InputText type="password" @bind-Value="passwordModel.OldPassword" /><ValidationMessage For="() => passwordModel.OldPassword" class="text-danger" /></div>
                        <div class="settings-form-group"><label>New Password</label><InputText type="password" @bind-Value="passwordModel.NewPassword" /><ValidationMessage For="() => passwordModel.NewPassword" class="text-danger" /></div>
                        <div class="settings-form-group"><label>Confirm New Password</label><InputText type="password" @bind-Value="passwordModel.ConfirmPassword" /><ValidationMessage For="() => passwordModel.ConfirmPassword" class="text-danger" /></div>
                        @if (!string.IsNullOrEmpty(passwordMessage))
                        {
                            @if (isPasswordSuccess)
                            {
                                <div class="success-msg">@passwordMessage</div>
                            }
                            else
                            {
                                <div class="error-msg">@passwordMessage</div>
                            }
                        }
                        <button type="submit" class="login-btn">Update Password</button>
                    </EditForm>
                </div>
            </div>

            <div id="settings-form-verification" class="settings-content hidden">
                <h1 class="page-title">Request Category Access</h1>
                <hr />
                <div class="post-card" style="padding: 20px;">
                    <p style="margin-bottom: 20px; color: #666;">
                        Request access to post in verified categories. Your request will be reviewed by administrators.
                    </p>

                    @if (!string.IsNullOrEmpty(accessRequestMessage))
                    {
                        @if (isAccessRequestSuccess)
                        {
                            <div class="success-msg">@accessRequestMessage</div>
                        }
                        else
                        {
                            <div class="error-msg">@accessRequestMessage</div>
                        }
                    }

                    <form @onsubmit="HandleAccessRequest" @onsubmit:preventDefault>
                        <div class="settings-form-group">
                            <label>Select Category</label>
                            <select @bind="selectedCategoryId" class="settings-form-group" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                                <option value="0">-- Select a verified category --</option>
                                @foreach (var cat in VerifiedCategoriesForRequest)
                                {
                                    <option value="@cat.Id"># @cat.CategoryName</option>
                                }
                            </select>
                        </div>

                        <div class="settings-form-group">
                            <label>Reason for Request</label>
                            <textarea rows="5" @bind="accessRequestReason" placeholder="Explain why you need access to post in this category..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box; resize: vertical;"></textarea>
                        </div>

                        <button type="submit" class="login-btn" disabled="@(selectedCategoryId == 0 || string.IsNullOrWhiteSpace(accessRequestReason))">
                            Submit Request
                        </button>
                    </form>

                    @if (UserAccessRequests != null && UserAccessRequests.Any())
                    {
                        <hr style="margin: 30px 0;" />
                        <h3 style="margin-bottom: 15px;">Your Requests</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            @foreach (var request in UserAccessRequests.OrderByDescending(r => r.DateCreated))
                            {
                                <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                        <div>
                                            <strong># @request.Category?.CategoryName</strong>
                                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                                @request.DateCreated.ToString("MMM dd, yyyy")
                                            </div>
                                        </div>
                                        <span style="padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold; text-transform: uppercase;
                                                                                                @(request.Status == "Approved" ? "background: #d4edda; color: #155724;" :
                                                                                                                                        request.Status == "Rejected" ? "background: #f8d7da; color: #721c24;" :
                                                                                                                                        "background: #fff3cd; color: #856404;")">
                                            @request.Status
                                        </span>
                                    </div>
                                    @if (!string.IsNullOrEmpty(request.Reason))
                                    {
                                        <div style="font-size: 14px; color: #555; margin-top: 8px;">
                                            <strong>Reason:</strong> @request.Reason
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </main>

    <aside class="sidebar sidebar-right" id="right-sidebar">
        <div class="sidebar-section">
            <h3>Verified Categories</h3>
            <ul class="category-list">
                @if (VerifiedCategories != null)
                {
                    @foreach (var cat in VerifiedCategories)
                    {
                        <li><a class="category-link" href="#" @onclick:preventDefault @onclick='@(() => NavigateToCategory(cat.Id))'><span class="hashtag">#</span> @cat.CategoryName <i class="fas fa-check-circle verified-badge" title="Verified"></i></a></li>
                    }
                }
            </ul>
        </div>
        <div class="sidebar-section">
            <h3>Following</h3>
            <ul class="category-list">
                @if (FollowedCategories != null && FollowedCategories.Any())
                {
                    @foreach (var cat in FollowedCategories)
                    {
                        <li>
                            <a class="category-link" href="#" @onclick:preventDefault @onclick='@(() => NavigateToCategory(cat.Id))'>
                                <span class="hashtag">#</span> @cat.CategoryName
                                @if (cat.IsVerified)
                                {
                                    <i class="fas fa-check-circle verified-badge" title="Verified"></i>
                                }
                            </a>
                        </li>
                    }
                }
            </ul>
        </div>
    </aside>
</div>

@* --- CROP MODAL --- *@
@if (showCropModal && !string.IsNullOrEmpty(tempImageSrc))
{
    <div class="modal" style="display:flex;">
        <div class="modal-content">
            <span class="modal-close" @onclick="CancelCrop">&times;</span>
            <h2>Adjust Profile Picture</h2>
            <p style="font-size:14px; color:#666; margin-bottom:15px;">Drag to position, use slider to zoom.</p>

            <div class="crop-container"
                 @onpointerdown="OnDragStart"
                 @onpointermove="OnDragMove"
                 @onpointerup="OnDragEnd"
                 @onpointerleave="OnDragEnd">

                <img id="imageToCrop" src="@tempImageSrc" class="crop-image"
                     style="transform: translate(@(offsetX)px, @(offsetY)px) scale(@scale);"
                     draggable="false" />
            </div>

            <div class="slider-container">
                <input type="range" min="1" max="3" step="0.1" @bind="scale" @bind:event="oninput" />
            </div>

            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button class="login-btn secondary" @onclick="CancelCrop">Cancel</button>
                <button class="login-btn" @onclick="SaveCroppedImage">Save Profile Photo</button>
            </div>
        </div>
    </div>
}

@* --- OTHER MODALS --- *@
<div class="modal" style="display: @(showCreateConfirm ? "flex" : "none")">
    <div class="modal-content"><span class="modal-close" @onclick="() => showCreateConfirm = false">&times;</span><h2>Category Not Found</h2><p>Would you like to create <b>#@searchTerm</b>?</p><div style="display: flex; gap: 10px; margin-top: 20px;"><button class="login-btn" style="flex:1;" @onclick="NavigateToCreate">Yes, Create</button><button class="login-btn secondary" style="flex:1;" @onclick="() => showCreateConfirm = false">Cancel</button></div></div>
</div>
<div id="auth-overlay" class="auth-overlay" style="display: @(ShowLoginOverlay ? "flex" : "none")">
    <div class="auth-card">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3 style="margin:0;">Welcome</h3><span style="cursor:pointer; font-size:20px;" onclick="document.getElementById('auth-overlay').style.display = 'none'">&times;</span></div>@if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="error-msg">@ErrorMessage</div>
        }
        <div id="login-view"><form action="api/Account/login" method="post"><div class="auth-input-group"><input type="text" name="username" placeholder="Username" required /></div><div class="auth-input-group"><input type="password" name="password" placeholder="Password" required /></div><button type="submit" class="auth-btn">Log In</button></form><div class="auth-switch">Don't have an account? <a onclick="toggleAuthMode()">Register</a></div></div><div id="register-view" class="hidden"><form action="api/Account/register" method="post"><div class="auth-input-group"><input type="email" name="email" placeholder="Email Address" required /></div><div class="auth-input-group"><input type="text" name="username" placeholder="Username" required /></div><div class="auth-input-group"><input type="password" name="password" placeholder="Password" required /></div><button type="submit" class="auth-btn">Sign Up</button></form><div class="auth-switch">Already have an account? <a onclick="toggleAuthMode()">Log In</a></div></div>
    </div>
</div>

@code {
    [SupplyParameterFromQuery] public string? Error { get; set; }

    private string searchTerm = "";
    private string ErrorMessage = "";
    private bool ShowLoginOverlay = false;
    private bool showCreateConfirm = false;

    private List<Categories> RecentCategories = new();
    private List<Categories> VerifiedCategories = new();
    private List<Categories> VerifiedCategoriesForRequest = new();
    private List<Categories> FollowedCategories = new();
    private List<Posts> FeedPosts = new();
    private List<Posts> UserPosts = new();
    private List<CategoryAccessRequests> UserAccessRequests = new();

    private Users? currentUser;
    private string updateStatusMessage = "";

    // Access Request Form
    private int selectedCategoryId = 0;
    private string accessRequestReason = "";
    private string accessRequestMessage = "";
    private bool isAccessRequestSuccess = false;

    // --- CAROUSEL STATE ---
    private Dictionary<int, int> _carouselIndices = new();
    private int GetCurrentIndex(int postId) { if (!_carouselIndices.ContainsKey(postId)) _carouselIndices[postId] = 0; return _carouselIndices[postId]; }
    private void NextSlide(int postId, int totalCount) { var currentIndex = GetCurrentIndex(postId); _carouselIndices[postId] = (currentIndex + 1) % totalCount; }
    private void PrevSlide(int postId, int totalCount) { var currentIndex = GetCurrentIndex(postId); _carouselIndices[postId] = (currentIndex - 1 + totalCount) % totalCount; }

    // --- PASSWORD CHANGE MODEL ---
    private class PasswordChangeModel
    {
        [Required] public string OldPassword { get; set; } = "";
        [Required][StringLength(100, MinimumLength = 6)] public string NewPassword { get; set; } = "";
        [Compare("NewPassword")] public string ConfirmPassword { get; set; } = "";
    }
    private PasswordChangeModel passwordModel = new();
    private string passwordMessage = "";
    private bool isPasswordSuccess = false;

    // --- CROPPER STATE ---
    private bool showCropModal = false;
    private string? tempImageSrc; // Base64 of raw selected file
    private double offsetX = 0;
    private double offsetY = 0;
    private double scale = 1.0;
    private bool isDragging = false;
    private double startX, startY, initialOffsetX, initialOffsetY;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(Error)) { ErrorMessage = Error; ShowLoginOverlay = true; }
        try
        {
            using var context = DbFactory.CreateDbContext();

            VerifiedCategories = await context.Categories
                .Where(c => c.IsVerified == true)
                .OrderByDescending(c => c.DateCreated)
                .Take(5)
                .ToListAsync();

            VerifiedCategoriesForRequest = await context.Categories.Where(c => c.IsVerified == true).OrderBy(c => c.CategoryName).ToListAsync();
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userPrincipal = authState.User;
            if (userPrincipal.Identity != null && userPrincipal.Identity.IsAuthenticated)
            {
                var userId = userPrincipal.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                if (string.IsNullOrEmpty(userId)) { using var scope = ScopeFactory.CreateScope(); var userManager = scope.ServiceProvider.GetRequiredService<UserManager<Users>>(); var dbUser = await userManager.GetUserAsync(userPrincipal); userId = dbUser?.Id; currentUser = dbUser; } else if (currentUser == null) { using var scope = ScopeFactory.CreateScope(); var userManager = scope.ServiceProvider.GetRequiredService<UserManager<Users>>(); currentUser = await userManager.FindByIdAsync(userId); }
                if (currentUser == null) { ForceLogout(); return; }
                if (!string.IsNullOrEmpty(userId))
                {
                    RecentCategories = await context.Categories.Where(c => c.CreatedBy == userId).OrderByDescending(c => c.DateCreated).Take(5).ToListAsync();
                    FollowedCategories = await context.CategoryFollows.Where(cf => cf.UserId == userId).Include(cf => cf.Category).Select(cf => cf.Category!).ToListAsync();
                    var followedCategoryIds = FollowedCategories.Select(c => c.Id).ToList();

                    // --- FETCH WITH LIKES ---
                    FeedPosts = await context.Posts
                        .Where(p => followedCategoryIds.Contains(p.CategoryId))
                        .Include(p => p.User)
                        .Include(p => p.Category)
                        .Include(p => p.Media)
                        .Include(p => p.Likes) // Includes likes in the feed
                        .OrderByDescending(p => p.DateCreated)
                        .ToListAsync();

                    UserPosts = await context.Posts
                        .Where(p => p.UserId == userId)
                        .Include(p => p.User)
                        .Include(p => p.Category)
                        .Include(p => p.Media)
                        .Include(p => p.Likes) // Includes likes in profile posts
                        .OrderByDescending(p => p.DateCreated)
                        .ToListAsync();

                    UserAccessRequests = await context.CategoryAccessRequests.Where(r => r.UserId == userId).Include(r => r.Category).OrderByDescending(r => r.DateCreated).ToListAsync();
                }
            }
        }
        catch (Exception ex) { Console.WriteLine("Error: " + ex.Message); }
    }

    private async Task ToggleLike(int postId)
    {
        if (currentUser == null)
        {
            ShowLoginOverlay = true;
            return;
        }

        try
        {
            using var context = DbFactory.CreateDbContext();

            // Find if the like already exists in DB
            var existingLike = await context.PostLikes
                .FirstOrDefaultAsync(l => l.PostID == postId && l.UserID == currentUser.Id);

            // Get local references to update UI instantly
            var feedPost = FeedPosts.FirstOrDefault(p => p.Id == postId);
            var userPost = UserPosts.FirstOrDefault(p => p.Id == postId);

            if (existingLike != null)
            {
                // --- UNLIKE LOGIC ---
                context.PostLikes.Remove(existingLike);

                // Update UI: Remove from local lists
                // We must find the specific like object in the local list to remove it
                if (feedPost != null)
                {
                    var l = feedPost.Likes.FirstOrDefault(x => x.UserID == currentUser.Id);
                    if (l != null) feedPost.Likes.Remove(l);
                }

                // If userPost is a DIFFERENT object instance, we must remove from it too.
                // If it is the SAME instance, the previous block already handled it.
                if (userPost != null && !object.ReferenceEquals(userPost, feedPost))
                {
                    var l = userPost.Likes.FirstOrDefault(x => x.UserID == currentUser.Id);
                    if (l != null) userPost.Likes.Remove(l);
                }
            }
            else
            {
                // --- LIKE LOGIC ---
                var newLike = new PostLikes
                {
                    PostID = postId,
                    UserID = currentUser.Id,
                    LikedAt = DateTime.Now
                };
                context.PostLikes.Add(newLike);

                // Update UI: Add to local lists
                if (feedPost != null)
                {
                    feedPost.Likes.Add(newLike);
                }

                // FIX: Only add to userPost if it is a DIFFERENT object instance.
                // If they are the same instance (ReferenceEquals), adding to feedPost already added it to userPost.
                if (userPost != null && !object.ReferenceEquals(userPost, feedPost))
                {
                    userPost.Likes.Add(newLike);
                }
            }

            await context.SaveChangesAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error toggling like: {ex.Message}");
        }
    }

    private async Task UnfollowCategory(int categoryId)
    {
        if (string.IsNullOrEmpty(currentUser?.Id)) return;
        try
        {
            using var context = DbFactory.CreateDbContext();
            var follow = await context.CategoryFollows.FirstOrDefaultAsync(c => c.CategoryId == categoryId && c.UserId == currentUser.Id);
            if (follow != null) { context.CategoryFollows.Remove(follow); await context.SaveChangesAsync(); FollowedCategories = await context.CategoryFollows.Where(cf => cf.UserId == currentUser.Id).Include(cf => cf.Category).Select(cf => cf.Category!).ToListAsync(); }
        }
        catch (Exception ex) { Console.WriteLine(ex.Message); }
    }

    // --- CROPPER LOGIC ---
    private async Task HandleProfileImageSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        // Limit to 2MB
        if (file.Size <= 1024 * 1024 * 2)
        {
            var buffer = new byte[file.Size];
            await file.OpenReadStream(1024 * 1024 * 2).ReadAsync(buffer);
            tempImageSrc = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
            // Reset crop state
            offsetX = 0; offsetY = 0; scale = 1.0;
            showCropModal = true;
        }
        else
        {
            updateStatusMessage = "Error: File too large. Max size is 2MB.";
        }
    }

    private void OnDragStart(PointerEventArgs e) { isDragging = true; startX = e.ClientX; startY = e.ClientY; initialOffsetX = offsetX; initialOffsetY = offsetY; }
    private void OnDragMove(PointerEventArgs e) { if (isDragging) { offsetX = initialOffsetX + (e.ClientX - startX); offsetY = initialOffsetY + (e.ClientY - startY); } }
    private void OnDragEnd(PointerEventArgs e) { isDragging = false; }
    private void CancelCrop() { showCropModal = false; tempImageSrc = null; }

    private async Task SaveCroppedImage()
    {
        if (currentUser == null || string.IsNullOrEmpty(tempImageSrc)) return;
        try
        {
            // Call JS to get the cropped base64 string
            var croppedBase64 = await JSRuntime.InvokeAsync<string>("generateCroppedImage", tempImageSrc, offsetX, offsetY, scale, 250);

            // Convert Base64 back to file
            var base64Data = croppedBase64.Split(',')[1];
            var imageBytes = Convert.FromBase64String(base64Data);

            // Save to Server
            var fileName = $"{Guid.NewGuid()}.jpg";
            var uploadsFolder = Path.Combine(Environment.WebRootPath, "uploads");
            if (!Directory.Exists(uploadsFolder)) Directory.CreateDirectory(uploadsFolder);
            var filePath = Path.Combine(uploadsFolder, fileName);
            await File.WriteAllBytesAsync(filePath, imageBytes);

            // Update Database
            using var scope = ScopeFactory.CreateScope();
            var userManager = scope.ServiceProvider.GetRequiredService<UserManager<Users>>();
            var userToUpdate = await userManager.FindByIdAsync(currentUser.Id);
            if (userToUpdate != null)
            {
                userToUpdate.ProfileImage = $"/uploads/{fileName}";
                await userManager.UpdateAsync(userToUpdate);
                currentUser.ProfileImage = userToUpdate.ProfileImage;
            }

            showCropModal = false;
            updateStatusMessage = "Profile picture updated!";
            StateHasChanged();
        }
        catch (Exception ex) { updateStatusMessage = "Error saving image: " + ex.Message; }
    }

    // --- PROFILE TEXT UPDATE ---
    private async Task UpdateProfile()
    {
        if (currentUser == null) return;
        try
        {
            using var scope = ScopeFactory.CreateScope();
            var userManager = scope.ServiceProvider.GetRequiredService<UserManager<Users>>();
            var userToUpdate = await userManager.FindByIdAsync(currentUser.Id);
            if (userToUpdate != null)
            {
                userToUpdate.DisplayName = currentUser.DisplayName;
                userToUpdate.Bio = currentUser.Bio;

                var result = await userManager.UpdateAsync(userToUpdate);
                if (result.Succeeded)
                {
                    updateStatusMessage = "Profile updated successfully!";
                    currentUser = userToUpdate;
                    StateHasChanged();
                }
                else { updateStatusMessage = "Error: " + string.Join(", ", result.Errors.Select(e => e.Description)); }
            }
        }
        catch (Exception ex) { updateStatusMessage = "Error updating: " + ex.Message; }
    }

    private async Task HandlePasswordChange() { /* Implement password change logic */ }
    private void ForceLogout() => Navigation.NavigateTo("/api/Account/logout", true);
    private void NavigateToCategory(int id) => Navigation.NavigateTo($"/category/{id}");
    private async Task HandleCategorySearch() { if (!string.IsNullOrWhiteSpace(searchTerm)) { using var context = DbFactory.CreateDbContext(); var cat = await context.Categories.FirstOrDefaultAsync(c => c.CategoryName.ToLower() == searchTerm.ToLower()); if (cat != null) Navigation.NavigateTo($"/category/{cat.Id}"); else showCreateConfirm = true; } }
    private void NavigateToCreate() => Navigation.NavigateTo($"/categories/create?name={searchTerm}");
    private void NavigateToAdmin() { Navigation.NavigateTo("admin", forceLoad: true); }

    private async Task HandleAccessRequest()
    {
        if (selectedCategoryId == 0 || string.IsNullOrWhiteSpace(accessRequestReason))
        {
            accessRequestMessage = "Please select a category and provide a reason.";
            isAccessRequestSuccess = false;
            return;
        }

        if (currentUser == null || string.IsNullOrEmpty(currentUser.Id))
        {
            accessRequestMessage = "You must be logged in to submit a request.";
            isAccessRequestSuccess = false;
            return;
        }

        try
        {
            using var context = DbFactory.CreateDbContext();

            var existingRequest = await context.CategoryAccessRequests
                .FirstOrDefaultAsync(r => r.UserId == currentUser.Id && r.CategoryId == selectedCategoryId && r.Status == "Pending");

            if (existingRequest != null)
            {
                accessRequestMessage = "You already have a pending request for this category.";
                isAccessRequestSuccess = false;
                return;
            }

            var approvedRequest = await context.CategoryAccessRequests
                .FirstOrDefaultAsync(r => r.UserId == currentUser.Id && r.CategoryId == selectedCategoryId && r.Status == "Approved");

            if (approvedRequest != null)
            {
                accessRequestMessage = "You already have approved access to this category.";
                isAccessRequestSuccess = false;
                return;
            }

            var newRequest = new CategoryAccessRequests
            {
                UserId = currentUser.Id,
                CategoryId = selectedCategoryId,
                Reason = accessRequestReason,
                Status = "Pending",
                DateCreated = DateTime.Now,
                DateUpdated = DateTime.Now,
                CreatedBy = currentUser.Id
            };

            context.CategoryAccessRequests.Add(newRequest);
            await context.SaveChangesAsync();

            accessRequestMessage = "Your access request has been submitted successfully.";
            isAccessRequestSuccess = true;

            selectedCategoryId = 0;
            accessRequestReason = "";

            UserAccessRequests = await context.CategoryAccessRequests
                .Where(r => r.UserId == currentUser.Id)
                .Include(r => r.Category)
                .OrderByDescending(r => r.DateCreated)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            accessRequestMessage = "Error submitting request: " + ex.Message;
            isAccessRequestSuccess = false;
        }
    }
}