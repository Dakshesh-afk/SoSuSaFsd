@page "/"
@rendermode InteractiveServer
@using SoSuSaFsd.Components.Pages.HomeComponents
@using SoSuSaFsd.Components.Common
@using SoSuSaFsd.Data
@using SoSuSaFsd.Domain
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using System.ComponentModel.DataAnnotations
@using System.IO
@inject IDbContextFactory<SoSuSaFsdContext> DbFactory
@inject IServiceScopeFactory ScopeFactory
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider
@inject IWebHostEnvironment Environment
@inject SoSuSaFsd.Services.IPostService PostService
@inject SoSuSaFsd.Services.ICategoryService CategoryService

<PageTitle>SoSuSa - Home</PageTitle>

@* HEADER *@
<HomeHeader 
    HeaderSearchTerm="@headerSearchTerm"
    CurrentUser="@currentUser"
    OnHeaderSearchTermChanged="@((value) => headerSearchTerm = value)"
    OnHeaderSearch="@(async () => await HandleHeaderSearch())"
    OnRefresh="@RefreshPage"
    OnLogout="@ForceLogout"
    OnNavigateToAdmin="@NavigateToAdmin"
    OnShowLogin="@(() => ShowLoginOverlay = true)" />

@* SEARCH RESULTS DROPDOWN *@
<SearchResultsDropdown 
    HasSearchedPosts="@HasSearchedPosts"
    HasSearchedUsers="@HasSearchedUsers"
    PostSearchResults="@PostSearchResults"
    UserSearchResults="@UserSearchResults"
    HeaderSearchTerm="@headerSearchTerm"
    CurrentActiveSection="@currentActiveSection"
    OnSearchPostClicked="@((categoryId, postId) => OnSearchPostClicked(categoryId, postId))"
    OnSearchUserClicked="@((username) => OnSearchUserClicked(username))" />

<div class="main-layout">
    @* LEFT SIDEBAR *@
    <LeftSidebar 
        CurrentUser="@currentUser"
        FollowedCategories="@FollowedCategories"
        UserPostsCount="@UserPosts.Count"
        CategorySearchTerm="@searchTerm"
        OnCategorySearchTermChanged="@((value) => searchTerm = value)"
        OnCategorySearch="@HandleCategorySearch"
        OnCategoryClick="@NavigateToCategory" />

    <main class="feed-area">
        @* HOME FEED *@
        <div id="feed-home" class="section-view active">
            <HomeFeed 
                FeedPosts="@FeedPosts"
                CurrentUser="@currentUser"
                DebugRenderPosts="@DebugRenderPosts"
                ShowComments="@_showComments"
                PostComments="@_postComments"
                CommentDrafts="@_commentDrafts"
                CarouselIndices="@_carouselIndices"
                ActiveReplyBoxes="@_activeReplyBoxes"
                ReplyDrafts="@_replyDrafts"
                OnLike="@ToggleLike"
                OnComment="@ToggleComments"
                OnReport="@OpenReportModal"
                OnUpdateDraft="@UpdateCommentDraft"
                OnSubmitComment="@SubmitComment"
                OnCarouselChange="@UpdateCarouselIndex"
                OnToggleReply="@ToggleReplyBox"
                OnUpdateReplyDraft="@UpdateReplyDraft"
                OnSubmitReply="@SubmitReply" />
        </div>

        @* PROFILE FEED *@
        <div id="feed-profile" class="section-view">
            <ProfileFeed 
                UserPosts="@UserPosts"
                CurrentUser="@currentUser"
                ShowComments="@_showComments"
                PostComments="@_postComments"
                CommentDrafts="@_commentDrafts"
                CarouselIndices="@_carouselIndices"
                ActiveReplyBoxes="@_activeReplyBoxes"
                ReplyDrafts="@_replyDrafts"
                OnLike="@ToggleLike"
                OnComment="@ToggleComments"
                OnReport="@OpenReportModal"
                OnUpdateDraft="@UpdateCommentDraft"
                OnSubmitComment="@SubmitComment"
                OnCarouselChange="@UpdateCarouselIndex"
                OnToggleReply="@ToggleReplyBox"
                OnUpdateReplyDraft="@UpdateReplyDraft"
                OnSubmitReply="@SubmitReply" />
        </div>

        @* FOLLOWING FEED *@
        <div id="feed-following" class="section-view">
            <FollowingFeed 
                FollowedCategories="@FollowedCategories"
                OnUnfollow="@UnfollowCategory" />
        </div>

        @* SETTINGS AREA *@
        <div id="feed-settings" class="section-view">
            <SettingsPanel 
                CurrentUser="@currentUser"
                UpdateStatusMessage="@updateStatusMessage"
                PasswordModel="@passwordModel"
                PasswordMessage="@passwordMessage"
                IsPasswordSuccess="@isPasswordSuccess"
                VerifiedCategoriesForRequest="@VerifiedCategoriesForRequest"
                SelectedCategoryId="@selectedCategoryId"
                AccessRequestReason="@accessRequestReason"
                AccessRequestMessage="@accessRequestMessage"
                IsAccessRequestSuccess="@isAccessRequestSuccess"
                UserAccessRequests="@UserAccessRequests"
                OnUpdateProfile="@(async () => await UpdateProfile())"
                OnProfileImageSelected="@(async (e) => await HandleProfileImageSelected(e))"
                OnPasswordChange="@HandlePasswordChange"
                OnAccessRequest="@(async () => await HandleAccessRequest())"
                OnSelectedCategoryIdChanged="@((value) => selectedCategoryId = value)"
                OnAccessRequestReasonChanged="@((value) => accessRequestReason = value)" />
        </div>
    </main>

    @* RIGHT SIDEBAR *@
    <aside class="sidebar sidebar-right" id="right-sidebar">
        <div class="sidebar-section">
            <h3>Verified Categories</h3>
            <ul class="category-list">
                @if (VerifiedCategories != null)
                {
                    @foreach (var cat in VerifiedCategories)
                    {
                        <li><a class="category-link" href="#" @onclick:preventDefault @onclick='@(() => NavigateToCategory(cat.Id))'><span class="link-text-wrapper"><span class="hashtag">#</span> @cat.CategoryName</span> <i class="fas fa-check-circle verified-badge" title="Verified"></i></a></li>
                    }
                }
            </ul>
        </div>
        <div class="sidebar-section">
            <h3>Recently Created</h3>
            <ul class="category-list">
                @if (RecentCategories != null && RecentCategories.Any())
                {
                    @foreach (var cat in RecentCategories)
                    {
                        <li>
                            <a class="category-link" href="#" @onclick:preventDefault @onclick='@(() => NavigateToCategory(cat.Id))'>
                                <span class="link-text-wrapper"><span class="hashtag">#</span> @cat.CategoryName</span>
                                @if (cat.IsVerified)
                                {
                                    <i class="fas fa-check-circle verified-badge" title="Verified"></i>
                                }
                            </a>
                        </li>
                    }
                }
                else
                {
                    <AuthorizeView>
                        <Authorized><li style="color:#666; padding-left:10px;">No categories created yet.</li></Authorized>
                        <NotAuthorized><li style="color:#666; padding-left:10px;">Login to see your categories.</li></NotAuthorized>
                    </AuthorizeView>
                }
            </ul>
        </div>
    </aside>
</div>

@* MODALS *@
<HomeReportModal 
    ShowReportModal="@showReportModal"
    ReportReasonSelection="@reportReasonSelection"
    ReportReasonDetails="@reportReasonDetails"
    OnClose="@(() => showReportModal = false)"
    OnReportReasonSelectionChanged="@((value) => reportReasonSelection = value)"
    OnReportReasonDetailsChanged="@((value) => reportReasonDetails = value)"
    OnSubmitReport="@(async () => await SubmitReport())" />

<NotificationModal 
    ShowNotificationModal="@showNotificationModal"
    NotificationMessage="@notificationMessage"
    NotificationType="@notificationType"
    OnClose="@CloseNotification" />

<CategorySearchModal 
    ShowCreateConfirm="@showCreateConfirm"
    SearchTerm="@searchTerm"
    OnClose="@(() => showCreateConfirm = false)"
    OnNavigateToCreate="@(() => NavigateToCreate())" />

<div id="auth-overlay" class="auth-overlay" style="display: @(ShowLoginOverlay ? "flex" : "none")">
    <div class="auth-card">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3 style="margin:0;">Welcome</h3><span style="cursor:pointer; font-size:20px;" onclick="document.getElementById('auth-overlay').style.display = 'none'">&times;</span></div>
        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="error-msg">@ErrorMessage</div>
        }
        <div id="login-view"><form action="api/Account/login" method="post"><div class="auth-input-group"><input type="text" name="username" placeholder="Username" required /></div><div class="auth-input-group"><input type="password" name="password" placeholder="Password" required /></div><button type="submit" class="auth-btn">Log In</button></form><div class="auth-switch">Don't have an account? <a onclick="toggleAuthMode()">Register</a></div></div>
        <div id="register-view" class="hidden"><form action="api/Account/register" method="post"><div class="auth-input-group"><input type="email" name="email" placeholder="Email Address" required /></div><div class="auth-input-group"><input type="text" name="username" placeholder="Username" required /></div><div class="auth-input-group"><input type="password" name="password" placeholder="Password" required /></div><button type="submit" class="auth-btn">Sign Up</button></form><div class="auth-switch">Already have an account? <a onclick="toggleAuthMode()">Log In</a></div></div>
    </div>
</div>

<script>
    function showSection(section) {
        document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.settings-content').forEach(el => el.classList.add('hidden'));

        var sidebarId = 'sidebar-' + section;
        var feedId = 'feed-' + section;

        if (section === 'following') {
            sidebarId = 'sidebar-profile';
        }

        var sidebar = document.getElementById(sidebarId);
        var feed = document.getElementById(feedId);

        if(sidebar) sidebar.classList.add('active');
        if(feed) feed.classList.add('active');

        document.querySelectorAll('.main-nav a').forEach(el => el.classList.remove('active-link'));

        var navSection = section;
        if(section === 'following') navSection = 'profile';

        var navLink = document.getElementById('nav-' + navSection);
        if(navLink) navLink.classList.add('active-link');

        if(section === 'settings') {
            showSettingsForm('profile');
        }

        try {
            var headerSearchWrapper = document.getElementById('header-search-wrapper');
            var rightSidebar = document.getElementById('right-sidebar');
            var searchInput = document.getElementById('header-search-input');

            if (section === 'profile' || section === 'following') {
                if(headerSearchWrapper) headerSearchWrapper.style.display = 'flex';
                if(searchInput) searchInput.placeholder = 'Search users...';
                if(rightSidebar) rightSidebar.style.display = 'none';
            } else if (section === 'settings') {
                if(headerSearchWrapper) headerSearchWrapper.style.display = 'none';
                if(rightSidebar) rightSidebar.style.display = 'none';
                showSettingsForm('profile');
            } else {
                if(headerSearchWrapper) headerSearchWrapper.style.display = 'flex';
                if(searchInput) searchInput.placeholder = 'Search posts...';
                if(rightSidebar) rightSidebar.style.display = 'flex';
            }
        } catch (e) { }

        window.currentSection = section;
    }

    function showSettingsForm(formName) {
        document.querySelectorAll('.settings-content').forEach(el => {
            el.classList.add('hidden');
        });
        var target = document.getElementById('settings-form-' + formName);
        if(target) {
            target.classList.remove('hidden');
        }
        document.querySelectorAll('.sidebar-section .category-link').forEach(el => el.classList.remove('active-setting'));
        var link = document.getElementById('set-link-' + formName);
        if(link) link.classList.add('active-setting');
    }

    function showLoginOverlay() {
        document.getElementById('auth-overlay').style.display = 'flex';
    }

    function toggleAuthMode() {
        var login = document.getElementById('login-view');
        var reg = document.getElementById('register-view');
        if(login.classList.contains('hidden')) {
            login.classList.remove('hidden');
            reg.classList.add('hidden');
        } else {
            login.classList.add('hidden');
            reg.classList.remove('hidden');
        }
    }
</script>

@code {
    [SupplyParameterFromQuery] public string? Error { get; set; }

    // ========== STATE MANAGEMENT ==========
    private string searchTerm = "";
    private string headerSearchTerm = "";
    private string ErrorMessage = "";
    private bool ShowLoginOverlay = false;
    private bool showCreateConfirm = false;
    private string updateStatusMessage = "";
    private bool HasSearchedPosts = false;
    private bool HasSearchedUsers = false;
    private string currentActiveSection = "home";

    // Data collections
    private List<Categories> RecentCategories = new();
    private List<Categories> VerifiedCategories = new();
    private List<Categories> VerifiedCategoriesForRequest = new();
    private List<Categories> FollowedCategories = new();
    private List<Posts> FeedPosts = new();
    private List<Posts> UserPosts = new();
    private List<CategoryAccessRequests> UserAccessRequests = new();
    private List<Posts> PostSearchResults = new();
    private List<Users> UserSearchResults = new();

    // User info
    private Users? currentUser;
    private int selectedCategoryId = 0;
    private string accessRequestReason = "";
    private string accessRequestMessage = "";
    private bool isAccessRequestSuccess = false;

    // Comments/interactions
    private Dictionary<int, bool> _showComments = new();
    private Dictionary<int, List<Comments>> _postComments = new();
    private Dictionary<int, string> _commentDrafts = new();
    private Dictionary<int, int> _carouselIndices = new();

    // Reply Management (NEW)
    private Dictionary<int, bool> _activeReplyBoxes = new(); // Key: CommentId (Parent)
    private Dictionary<int, string> _replyDrafts = new();    // Key: CommentId (Parent)

    // Debugging flag to temporarily render simple post markup instead of PostCard component
    private bool DebugRenderPosts = false;

    // Modals
    private bool showReportModal = false;
    private int reportPostId = 0;
    private string reportReasonSelection = "Spam";
    private string reportReasonDetails = "";
    private bool showNotificationModal = false;
    private string notificationMessage = "";
    private string notificationType = "success";

    // Password change
    private SettingsPanel.PasswordChangeModel passwordModel = new();
    private string passwordMessage = "";
    private bool isPasswordSuccess = false;

    // ========== LIFECYCLE ==========
    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(Error)) { ErrorMessage = Error; ShowLoginOverlay = true; }
        await LoadUserAndCategories();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload data when returning to this page
        await base.OnParametersSetAsync();
        await LoadUserAndCategories();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Set up visibility change detection to refresh feed when page comes into focus
            try
            {
                await JSRuntime.InvokeVoidAsync("window.addEventListener", "visibilitychange",
                    DotNetObjectReference.Create(this));
            }
            catch { }
        }

        // Check for section changes from JavaScript
        try
        {
            var newSection = await JSRuntime.InvokeAsync<string>("eval", "window.currentSection || 'home'");
            if (newSection != currentActiveSection)
            {
                currentActiveSection = newSection;
                ClearHeaderSearchState();
                StateHasChanged();
            }
        }
        catch { }

        await base.OnAfterRenderAsync(firstRender);
    }

    private void ClearHeaderSearchState()
    {
        headerSearchTerm = "";
        PostSearchResults = new List<Posts>();
        UserSearchResults = new List<Users>();
        HasSearchedPosts = false;
        HasSearchedUsers = false;
    }

    // UPDATED METHOD: Accepts CategoryId and PostId
    private void OnSearchPostClicked(int categoryId, int postId)
    {
        // Clear UI state first
        ClearHeaderSearchState();
        // Navigate to the category page with focusPostId parameter
        Navigation.NavigateTo($"/category/{categoryId}?focusPostId={postId}", true);
    }

    private void OnSearchUserClicked(string? username)
    {
        if (string.IsNullOrEmpty(username)) return;
        ClearHeaderSearchState();
        Navigation.NavigateTo($"/profile/{username}", true);
    }

    // ========== DATA LOADING ==========
    private async Task LoadUserAndCategories()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userPrincipal = authState.User;

            if (userPrincipal.Identity != null && userPrincipal.Identity.IsAuthenticated)
            {
                var userId = userPrincipal.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

                if (string.IsNullOrEmpty(userId))
                {
                    using var scope = ScopeFactory.CreateScope();
                    var userManager = scope.ServiceProvider.GetRequiredService<UserManager<Users>>();
                    var dbUser = await userManager.GetUserAsync(userPrincipal);
                    userId = dbUser?.Id;
                    currentUser = dbUser;
                }
                else if (currentUser == null)
                {
                    using var scope = ScopeFactory.CreateScope();
                    var userManager = scope.ServiceProvider.GetRequiredService<UserManager<Users>>();
                    currentUser = await userManager.FindByIdAsync(userId);
                }

                if (currentUser == null) { ForceLogout(); return; }

                if (!string.IsNullOrEmpty(userId))
                {
                    // Use CategoryService instead of direct DbContext
                    VerifiedCategories = await CategoryService.GetVerifiedCategoriesAsync(5);
                    VerifiedCategoriesForRequest = await CategoryService.GetVerifiedCategoriesAsync(100); // Get all for dropdown
                    RecentCategories = await CategoryService.GetRecentCategoriesAsync(userId, 5);
                    FollowedCategories = await CategoryService.GetFollowedCategoriesAsync(userId);

                    // Use PostService instead of direct DbContext
                    var followedCategoryIds = FollowedCategories.Select(c => c.Id).ToList();
                    if (followedCategoryIds.Any())
                    {
                        FeedPosts = await PostService.GetUserFeedPostsAsync(followedCategoryIds);
                    }
                    else
                    {
                        FeedPosts = new List<Posts>();
                    }
                    
                    UserPosts = await PostService.GetUserPostsAsync(userId);

                    // Access requests still need direct access (no service method yet)
                    using var context = DbFactory.CreateDbContext();
                    UserAccessRequests = await context.CategoryAccessRequests
                        .Where(r => r.UserId == userId)
                        .Include(r => r.Category)
                        .OrderByDescending(r => r.DateCreated)
                        .ToListAsync();
                }
            }
        }
        catch (Exception ex) { Console.WriteLine("Error: " + ex.Message); }
    }

    private async Task RefreshFeed()
    {
        try
        {
            if (string.IsNullOrEmpty(currentUser?.Id)) return;

            // Use CategoryService
            FollowedCategories = await CategoryService.GetFollowedCategoriesAsync(currentUser.Id);
            
            // Use PostService
            var followedCategoryIds = FollowedCategories.Select(c => c.Id).ToList();
            if (followedCategoryIds.Any())
            {
                FeedPosts = await PostService.GetUserFeedPostsAsync(followedCategoryIds);
            }
            else
            {
                FeedPosts = new List<Posts>();
            }

            StateHasChanged();
        }
        catch (Exception ex) { Console.WriteLine($"Error refreshing feed: {ex.Message}"); }
    }

    // ========== CORE ACTIONS ==========
    private void ShowNotification(string message, string type)
    {
        notificationMessage = message;
        notificationType = type;
        showNotificationModal = true;
    }

    private void CloseNotification()
    {
        showNotificationModal = false;
        notificationMessage = "";
    }

    private void OpenReportModal(int postId)
    {
        if (currentUser == null)
        {
            ShowLoginOverlay = true;
            return;
        }
        reportPostId = postId;
        reportReasonSelection = "Spam";
        reportReasonDetails = "";
        showReportModal = true;
    }

    private async Task SubmitReport()
    {
        if (reportPostId == 0 || currentUser == null)
        {
            ShowNotification("Session error. Please refresh and try again.", "error");
            return;
        }

        try
        {
            // Check if user already reported (still need DbContext for this check)
            using var context = DbFactory.CreateDbContext();
            var existingReport = await context.Reports.FirstOrDefaultAsync(r =>
                r.PostID == reportPostId && r.ReporterID == currentUser.Id);

            if (existingReport != null)
            {
                showReportModal = false;
                if (existingReport.Status == "Dismissed")
                    ShowNotification("An Admin has already dismissed your report for this post.", "error");
                else
                    ShowNotification("You have already reported this post.", "error");
                return;
            }

            bool isAlreadyDismissed = await context.Reports.AnyAsync(r =>
                r.PostID == reportPostId && r.Status == "Dismissed");

            string finalReason = reportReasonSelection;
            if (!string.IsNullOrWhiteSpace(reportReasonDetails))
                finalReason = $"{reportReasonSelection}: {reportReasonDetails}";

            var newReport = new Reports
            {
                PostID = reportPostId,
                ReporterID = currentUser.Id,
                Reason = finalReason,
                Status = "Pending",
                DateCreated = DateTime.Now
            };

            // Use PostService
            await PostService.CreateReportAsync(newReport);
            
            showReportModal = false;

            if (isAlreadyDismissed)
                ShowNotification("Report submitted, but this content has already been reviewed and dismissed by admins.", "info");
            else
                ShowNotification("Report submitted successfully.", "success");
        }
        catch (Exception ex)
        {
            ShowNotification("Error sending report: " + ex.Message, "error");
        }
    }

    private async Task ToggleLike(int postId)
    {
        if (currentUser == null) { ShowLoginOverlay = true; return; }
        try
        {
            // Use PostService
            await PostService.ToggleLikeAsync(postId, currentUser.Id);

            // Update local state
            var feedPost = FeedPosts.FirstOrDefault(p => p.Id == postId);
            var userPost = UserPosts.FirstOrDefault(p => p.Id == postId);

            if (feedPost != null)
            {
                // Reload likes for this post
                using var context = DbFactory.CreateDbContext();
                feedPost.Likes = await context.PostLikes.Where(l => l.PostID == postId).ToListAsync();
            }

            if (userPost != null && !object.ReferenceEquals(userPost, feedPost))
            {
                using var context = DbFactory.CreateDbContext();
                userPost.Likes = await context.PostLikes.Where(l => l.PostID == postId).ToListAsync();
            }

            StateHasChanged();
        }
        catch (Exception ex) { Console.WriteLine($"Error toggling like: {ex.Message}"); }
    }

    private async Task ToggleComments(int postId)
    {
        if (!_showComments.ContainsKey(postId)) _showComments[postId] = false;
        _showComments[postId] = !_showComments[postId];

        if (_showComments[postId])
        {
            if (!_postComments.ContainsKey(postId) || _postComments[postId] == null)
            {
                try
                {
                    // Use PostService
                    _postComments[postId] = await PostService.GetPostCommentsAsync(postId);
                }
                catch (Exception ex) { Console.WriteLine("Error loading comments: " + ex.Message); }
            }
        }
        StateHasChange