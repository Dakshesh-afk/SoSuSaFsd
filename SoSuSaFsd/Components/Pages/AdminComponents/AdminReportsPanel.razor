@using SoSuSaFsd.Domain
@using SoSuSaFsd.Components.Pages.AdminComponents.ReportCardComponents

@* AdminReportsPanel - Reports management with grouping and filtering *@

<div class="space-y-4">
    @{
        var groupedQuery = AllReports
            .GroupBy(r => new { r.PostID, r.CommentID, r.CategoryID, r.TargetUserID });

        if (ReportFilter.Contains("pending"))
        {
            groupedQuery = groupedQuery.Where(g => !g.Any(r => r.Status == "Resolved" || r.Status == "Dismissed"));
        }

        IEnumerable<IGrouping<dynamic, Reports>> sortedGroups;

        if (ReportFilter.Contains("most"))
        {
            sortedGroups = groupedQuery.OrderByDescending(g => g.Count());
        }
        else
        {
            sortedGroups = groupedQuery.OrderByDescending(g => g.Max(r => r.DateCreated));
        }
    }

    @foreach (var group in sortedGroups)
    {
        <ReportCard 
            Group="@group"
            OnOpenContentModal="@OnOpenContentModal"
            OnDismissReportGroup="@OnDismissReportGroup"
            OnUndoDismiss="@OnUndoDismiss"
            OnRequestDelete="@OnRequestDelete" />
    }

    @if (!sortedGroups.Any())
    {
        <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-8 text-center text-gray-500">
            <i class="fas fa-check-circle text-4xl text-green-500 mb-3"></i>
            <p class="text-lg font-semibold text-gray-700">No reports found.</p>
            <p>Try changing the filter options.</p>
        </div>
    }
</div>

@code {
    [Parameter] public List<Reports> AllReports { get; set; } = new();
    [Parameter] public string ReportFilter { get; set; } = "recent_all";
    [Parameter] public EventCallback<int> OnOpenContentModal { get; set; }
    [Parameter] public EventCallback<int> OnDismissReportGroup { get; set; }
    [Parameter] public EventCallback<int> OnUndoDismiss { get; set; }
    [Parameter] public EventCallback<int> OnRequestDelete { get; set; }
}
