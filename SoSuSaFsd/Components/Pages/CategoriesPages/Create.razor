@page "/categories/create"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using SoSuSaFsd.Domain
@using SoSuSaFsd.Data
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@inject IDbContextFactory<SoSuSaFsdContext> DbFactory
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject IServiceScopeFactory ScopeFactory

<!-- Same styles as before -->
<style>
    body {
        font-family: 'Segoe UI', sans-serif;
        background: #f9f9f9;
        padding-top: 50px;
    }

    .auth-card {
        max-width: 500px;
        margin: 0 auto;
        background: white;
        padding: 40px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .form-control {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
    }

    .btn-black {
        width: 100%;
        padding: 12px;
        background: #333;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .btn-secondary {
        width: 100%;
        padding: 12px;
        background: white;
        color: #333;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-top: 10px;
        cursor: pointer;
    }
</style>

<div class="auth-card">
    <h2>Create New Category</h2>
    <hr />

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <p style="color:red; background:#fee; padding:10px;">@errorMessage</p>
    }

    <EditForm Model="NewCategory" OnValidSubmit="AddCategory">
        <DataAnnotationsValidator />

        <label>Category Name</label>
        <InputText @bind-Value="NewCategory.CategoryName" class="form-control" />

        <label>Description</label>
        <InputTextArea @bind-Value="NewCategory.CategoryDescription" class="form-control" rows="4" />

        <button type="submit" class="btn-black">Create Category</button>
        <button type="button" class="btn-secondary" @onclick='() => Navigation.NavigateTo("/")'>Cancel</button>
    </EditForm>
</div>

@code {
    [SupplyParameterFromQuery]
    public string? Name { get; set; }

    public Categories NewCategory { get; set; } = new();
    private string? errorMessage;

    protected override void OnInitialized()
    {
        if (!string.IsNullOrEmpty(Name)) NewCategory.CategoryName = Name;
    }

    private async Task AddCategory()
    {
        // 1. Get the real logged-in user from the Cookie/AuthState
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity.IsAuthenticated)
        {
            errorMessage = "You must be logged in to create a category.";
            return;
        }

        // 2. Get the actual User ID (Guid/String)
        var userId = user.FindFirst(c => c.Type == System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (userId == null)
        {
            // Fallback: try to find by name using UserManager if ID claim is missing
            using var scope = ScopeFactory.CreateScope();
            var userManager = scope.ServiceProvider.GetRequiredService<UserManager<Users>>();
            var dbUser = await userManager.GetUserAsync(user);
            userId = dbUser?.Id;
        }

        if (userId == null)
        {
            errorMessage = "Could not identify user.";
            return;
        }

        try
        {
            using var context = DbFactory.CreateDbContext();

            // Check duplicates
            if (await context.Categories.AnyAsync(c => c.CategoryName == NewCategory.CategoryName))
            {
                errorMessage = "Category already exists.";
                return;
            }

            // Save with User ID
            NewCategory.DateCreated = DateTime.Now;
            NewCategory.CreatedBy = userId; // <--- This is the key part!
            NewCategory.CategoryIsRestricted = false;

            context.Categories.Add(NewCategory);
            await context.SaveChangesAsync();

            Navigation.NavigateTo($"/category/{NewCategory.Id}");
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }
}