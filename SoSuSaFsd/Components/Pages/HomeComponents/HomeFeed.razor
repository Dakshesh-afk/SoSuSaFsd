@using SoSuSaFsd.Domain
@using SoSuSaFsd.Components.Common

@* HomeFeed - Main feed showing posts from followed categories *@

<div class="feed-header">
    <div class="feed-header-top">
        <h1 class="page-title">Home</h1>
        <button class="create-post-btn" onclick="alert('Join a category to post!')">Create Post</button>
    </div>
</div>
<hr />

@if (FeedPosts != null && FeedPosts.Any())
{
    @if (DebugRenderPosts)
    {
        <div style="background:#fffbe6; padding:12px; border-radius:8px; margin-bottom:12px;">
            <h4 style="margin-top:0;">Debug: FeedPosts (simple render)</h4>
            @foreach (var post in FeedPosts)
            {
                <div class="debug-post" style="padding:10px; border:1px dashed #ccc; margin-bottom:10px; background:#fff;">
                    <div style="font-size:14px; color:#666; margin-bottom:6px;"><strong>Category:</strong> @(post.Category?.CategoryName ?? "(none)") (Id: @post.CategoryId)</div>
                    <div style="font-weight:700;">@(post.User?.UserName ?? "Unknown") <span style="font-weight:400; color:#999;">• @post.DateCreated.ToString("MMM dd, yyyy • HH:mm")</span></div>
                    <div style="margin-top:6px;">@post.Content</div>
                    <div style="margin-top:8px; font-size:13px; color:#666;">Media: @(post.Media?.Count ?? 0) | Likes: @(post.Likes?.Count ?? 0)</div>
                </div>
            }
        </div>
    }
    else
    {
        @foreach (var post in FeedPosts)
        {
            <PostCard Post="post" 
                      CurrentUser="CurrentUser" 
                      OnLike="OnLike" 
                      OnComment="OnComment"
                      OnReport="OnReport" 
                      ShowComments="ShowComments" 
                      PostComments="PostComments"
                      CommentDrafts="CommentDrafts" 
                      OnUpdateDraft="OnUpdateDraft"
                      OnSubmitComment="OnSubmitComment" 
                      CarouselIndices="CarouselIndices" 
                      OnCarouselChange="OnCarouselChange"
                      ActiveReplyBoxes="ActiveReplyBoxes" 
                      ReplyDrafts="ReplyDrafts" 
                      OnToggleReply="OnToggleReply"
                      OnUpdateReplyDraft="OnUpdateReplyDraft" 
                      OnSubmitReply="OnSubmitReply" />
        }
    }
}
else
{
    <div style="text-align: center; color: #666; margin-top: 40px; padding: 20px;">
        <h3>Your feed is empty.</h3>
        <p>Follow categories to see posts here!</p>
    </div>
}

@code {
    /// <summary>
    /// List of posts to display in the feed
    /// </summary>
    [Parameter]
    public List<Posts> FeedPosts { get; set; } = new();

    /// <summary>
    /// Current logged-in user
    /// </summary>
    [Parameter]
    public Users? CurrentUser { get; set; }

    /// <summary>
    /// Dictionary tracking which posts have comments expanded
    /// </summary>
    [Parameter]
    public Dictionary<int, bool> ShowComments { get; set; } = new();

    /// <summary>
    /// Dictionary of loaded comments for each post
    /// </summary>
    [Parameter]
    public Dictionary<int, List<Comments>> PostComments { get; set; } = new();

    /// <summary>
    /// Dictionary of comment drafts for each post
    /// </summary>
    [Parameter]
    public Dictionary<int, string> CommentDrafts { get; set; } = new();

    /// <summary>
    /// Dictionary of carousel indices for posts with media
    /// </summary>
    [Parameter]
    public Dictionary<int, int> CarouselIndices { get; set; } = new();

    /// <summary>
    /// Dictionary tracking active reply boxes
    /// </summary>
    [Parameter]
    public Dictionary<int, bool> ActiveReplyBoxes { get; set; } = new();

    /// <summary>
    /// Dictionary of reply drafts
    /// </summary>
    [Parameter]
    public Dictionary<int, string> ReplyDrafts { get; set; } = new();

    /// <summary>
    /// Debug flag to render simple markup instead of PostCard
    /// </summary>
    [Parameter]
    public bool DebugRenderPosts { get; set; } = false;

    /// <summary>
    /// Callback when user likes a post
    /// </summary>
    [Parameter]
    public EventCallback<int> OnLike { get; set; }

    /// <summary>
    /// Callback when user toggles comments
    /// </summary>
    [Parameter]
    public EventCallback<int> OnComment { get; set; }

    /// <summary>
    /// Callback when user reports a post
    /// </summary>
    [Parameter]
    public EventCallback<int> OnReport { get; set; }

    /// <summary>
    /// Callback when user updates a comment draft
    /// </summary>
    [Parameter]
    public EventCallback<PostCard.CommentDraftEventArgs> OnUpdateDraft { get; set; }

    /// <summary>
    /// Callback when user submits a comment
    /// </summary>
    [Parameter]
    public EventCallback<int> OnSubmitComment { get; set; }

    /// <summary>
    /// Callback when carousel index changes
    /// </summary>
    [Parameter]
    public EventCallback<PostCard.CarouselEventArgs> OnCarouselChange { get; set; }

    /// <summary>
    /// Callback when user toggles reply box
    /// </summary>
    [Parameter]
    public EventCallback<int> OnToggleReply { get; set; }

    /// <summary>
    /// Callback when user updates a reply draft
    /// </summary>
    [Parameter]
    public EventCallback<PostCard.ReplyDraftEventArgs> OnUpdateReplyDraft { get; set; }

    /// <summary>
    /// Callback when user submits a reply
    /// </summary>
    [Parameter]
    public EventCallback<PostCard.SubmitReplyEventArgs> OnSubmitReply { get; set; }
}
