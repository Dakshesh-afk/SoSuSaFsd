@page "/Account/Login"

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Identity
@using SoSuSaFsd.Domain

@inject UserManager<Users> UserManager
@inject SignInManager<Users> SignInManager
@inject ILogger<Login> Logger
@inject NavigationManager NavigationManager

<PageTitle>Log in</PageTitle>

<div class="d-flex justify-content-center align-items-center vh-100" style="background-color: #f8f9fa;">
    <div class="card shadow-lg p-4" style="width: 100%; max-width: 400px; border-radius: 12px; border:none;">
        <div class="text-center mb-4">
            <h2 class="fw-bold text-dark">Welcome</h2>
        </div>

        <EditForm Model="Input" method="post" OnValidSubmit="LoginUser" FormName="login">
            <DataAnnotationsValidator />

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger text-center p-2 mb-3" role="alert" style="font-size: 14px;">
                    @errorMessage
                </div>
            }

            <div asp-validation-summary="ModelOnly" class="text-danger" role="alert"></div>

            <div class="form-floating mb-3">
                <InputText @bind-Value="Input.Email" class="form-control" autocomplete="username" aria-required="true" placeholder="name@example.com" style="border-radius: 8px;" />
                <label for="email" class="text-muted">Email address</label>
                <ValidationMessage For="() => Input.Email" class="text-danger" />
            </div>

            <div class="form-floating mb-3">
                <InputText @bind-Value="Input.Password" type="password" class="form-control" autocomplete="current-password" aria-required="true" placeholder="password" style="border-radius: 8px;" />
                <label for="password" class="text-muted">Password</label>
                <ValidationMessage For="() => Input.Password" class="text-danger" />
            </div>

            <button type="submit" class="w-100 btn btn-dark btn-lg py-2 fw-bold" style="border-radius: 8px;">Log In</button>

            <div class="text-center mt-3">
                <a href="Account/Register" class="text-muted text-decoration-none" style="font-size: 14px;">Don't have an account? Register</a>
            </div>
        </EditForm>
    </div>
</div>

@code {
    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    [SupplyParameterFromForm]
    public InputModel Input { get; set; } = new();

    private string? errorMessage;

    public async Task LoginUser()
    {
        errorMessage = null;

        // 1. LOOKUP USER BY EMAIL FIRST
        var user = await UserManager.FindByEmailAsync(Input.Email);

        if (user != null)
        {
            // 2. SIGN IN USING THE USERNAME FOUND (SoSuSaAdmin)
            var result = await SignInManager.PasswordSignInAsync(user.UserName!, Input.Password, Input.RememberMe, lockoutOnFailure: false);

            if (result.Succeeded)
            {
                Logger.LogInformation("User logged in.");

                // 3. CHECK ROLE AND REDIRECT
                if (user.Role == "Admin" || await UserManager.IsInRoleAsync(user, "Admin"))
                {
                    NavigationManager.NavigateTo("/admin", true);
                }
                else
                {
                    NavigationManager.NavigateTo(ReturnUrl ?? "/", true);
                }
                return;
            }
        }

        // If user not found OR password incorrect
        errorMessage = "Invalid login attempt.";
        Logger.LogWarning("Invalid login attempt.");
    }

    public sealed class InputModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = "";

        [Required]
        [DataType(DataType.Password)]
        public string Password { get; set; } = "";

        [Display(Name = "Remember me?")]
        public bool RememberMe { get; set; }
    }
}