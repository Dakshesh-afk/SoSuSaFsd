@using SoSuSaFsd.Domain
@using Microsoft.AspNetCore.Components
@inject NavigationManager Navigation

<div class="post-card">
    <div class="post-header">
        <div class="post-avatar" style="background-image: url('@(Post.User?.ProfileImage ?? "")');"></div>
        <div>
            <b>@(Post.User?.UserName ?? "User")</b>
            <div class="post-meta">
                <span style="font-size: 12px; color: #888;">@Post.DateCreated.ToString("MMM dd, yyyy • HH:mm")</span>
                <div class="post-category-tag">
                    Posted in <a href="#" @onclick:preventDefault @onclick='@(() => NavigateToCategory(Post.CategoryId))'>
                        #@Post.Category?.CategoryName
                        @if (Post.Category?.IsVerified == true)
                        {
                            <i class="fas fa-check-circle verified-badge" style="font-size:12px;" title="Verified"></i>
                        }
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="post-content">@Post.Content</div>

    @if (Post.Media != null && Post.Media.Any())
    {
        var mediaList = Post.Media.ToList();
        var totalMedia = mediaList.Count;
        var currentIndex = GetCurrentCarouselIndex(Post.Id);
        var activeMedia = mediaList[currentIndex];

        <div class="carousel-container">
            @if (totalMedia > 1)
            {
                <button class="carousel-btn prev" @onclick="() => PrevSlide(Post.Id, totalMedia)">&#10094;</button>
            }

            @if (activeMedia.MediaType == "Video")
            {
                <video controls class="carousel-media" src="@activeMedia.MediaPath" @key="activeMedia.MediaPath">
                    Your browser does not support the video tag.
                </video>
            }
            else
            {
                <img class="carousel-media" src="@activeMedia.MediaPath" alt="Post Media" @key="activeMedia.MediaPath" />
            }

            @if (totalMedia > 1)
            {
                <button class="carousel-btn next" @onclick="() => NextSlide(Post.Id, totalMedia)">&#10095;</button>
                <div class="carousel-counter">@(currentIndex + 1) / @totalMedia</div>
            }
        </div>
    }

    <div class="post-actions">
        <button class="action-btn" @onclick="() => OnLike.InvokeAsync(Post.Id)">
            @{
                var isLiked = Post.Likes.Any(l => l.UserID == CurrentUser?.Id);
                var likeCount = Post.Likes.Count;
            }
            @if (isLiked)
            {
                <i class="fas fa-heart" style="color: #e0245e; margin-right: 5px;"></i>
            }
            else
            {
                <i class="far fa-heart" style="margin-right: 5px;"></i>
            }
            @if (likeCount > 0)
            {
                <span>@likeCount</span>
            }
            else
            {
                <span>Like</span>
            }
        </button>

        <button class="action-btn" @onclick="() => OnComment.InvokeAsync(Post.Id)">
            <i class="far fa-comment"></i> Comment
        </button>

        <button class="action-btn" style="color: #666; font-size: 14px;" @onclick="() => OnReport.InvokeAsync(Post.Id)" title="Report Post">
            <i class="far fa-flag"></i> Report
        </button>
    </div>

    @if (ShowComments != null && ShowComments.ContainsKey(Post.Id) && ShowComments[Post.Id])
    {
        <div class="comment-section">
            <div class="comment-list">
                @if (PostComments != null && PostComments.ContainsKey(Post.Id) && PostComments[Post.Id] != null)
                {
                    // Filter for Parent Comments (where ParentCommentID is null)
                    var allComments = PostComments[Post.Id];
                    var parentComments = allComments.Where(c => c.ParentCommentID == null).OrderBy(c => c.DateCreated);

                    @foreach (var comment in parentComments)
                    {
                        // Get Replies for this specific parent
                        var replies = allComments.Where(c => c.ParentCommentID == comment.Id).OrderBy(c => c.DateCreated).ToList();

                        @* --- PARENT COMMENT --- *@
                        <div class="comment-item">
                            <div class="comment-avatar" style="background-image: url('@(comment.User?.ProfileImage ?? "")');"></div>
                            <div class="comment-bubble-wrapper" style="flex: 1;">
                                <div class="comment-bubble">
                                    <div>
                                        <span class="comment-user">@(comment.User?.UserName ?? "User")</span>
                                        <span class="comment-date">@comment.DateCreated.ToString("MMM dd, HH:mm")</span>
                                    </div>
                                    <div class="comment-text">@comment.Content</div>
                                </div>
                                <div class="comment-actions" style="margin-top: 2px; margin-left: 10px;">
                                    <button style="background:none; border:none; cursor:pointer; font-size:11px; color:#666; font-weight:600;"
                                            @onclick="() => OnToggleReply.InvokeAsync(comment.Id)">
                                        Reply
                                    </button>
                                </div>
                            </div>
                        </div>

                        @* --- NESTED REPLIES --- *@
                        @if (replies.Any())
                        {
                            <div class="replies-list" style="margin-left: 45px; border-left: 2px solid #eee; padding-left: 10px; margin-bottom: 10px;">
                                @foreach (var reply in replies)
                                {
                                    <div class="comment-item" style="margin-bottom: 8px;">
                                        <div class="comment-avatar" style="width: 24px; height: 24px; background-image: url('@(reply.User?.ProfileImage ?? "")');"></div>
                                        <div class="comment-bubble" style="padding: 8px 12px;">
                                            <div>
                                                <span class="comment-user" style="font-size: 11px;">@(reply.User?.UserName ?? "User")</span>
                                                <span class="comment-date" style="font-size: 10px;">@reply.DateCreated.ToString("MMM dd, HH:mm")</span>
                                            </div>
                                            <div class="comment-text" style="font-size: 13px;">@reply.Content</div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }

                        @* --- REPLY INPUT BOX (Toggled via Reply Button) --- *@
                        @if (ActiveReplyBoxes != null && ActiveReplyBoxes.ContainsKey(comment.Id) && ActiveReplyBoxes[comment.Id])
                        {
                            <div class="reply-input-area" style="margin-left: 45px; margin-bottom: 15px; display: flex; gap: 5px;">
                                <input type="text" class="comment-input" style="font-size: 13px; padding: 6px;" placeholder="Write a reply..."
                                       value="@(ReplyDrafts != null && ReplyDrafts.ContainsKey(comment.Id) ? ReplyDrafts[comment.Id] : "")"
                                       @onchange="@(e => OnUpdateReplyDraft.InvokeAsync(new ReplyDraftEventArgs { ParentCommentId = comment.Id, Content = e.Value?.ToString() }))" />
                                <button class="comment-send-btn" style="padding: 0 10px; font-size: 12px;"
                                        @onclick="() => OnSubmitReply.InvokeAsync(new SubmitReplyEventArgs { PostId = Post.Id, ParentCommentId = comment.Id })">
                                    Reply
                                </button>
                            </div>
                        }
                    }
                }
            </div>

            @* --- MAIN COMMENT INPUT --- *@
            <div class="comment-input-area">
                <input type="text" class="comment-input" placeholder="Write a comment..."
                       value="@(CommentDrafts != null && CommentDrafts.ContainsKey(Post.Id) ? CommentDrafts[Post.Id] : "")"
                       @onchange="@(e => OnUpdateDraft.InvokeAsync(new CommentDraftEventArgs { PostId = Post.Id, Content = e.Value?.ToString() }))" />
                <button class="comment-send-btn" @onclick="() => OnSubmitComment.InvokeAsync(Post.Id)">Post</button>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public Posts Post { get; set; } = null!;
    [Parameter] public Users? CurrentUser { get; set; }
    [Parameter] public EventCallback<int> OnLike { get; set; }
    [Parameter] public EventCallback<int> OnComment { get; set; }
    [Parameter] public EventCallback<int> OnReport { get; set; }

    // Main Comment Data
    [Parameter] public Dictionary<int, bool>? ShowComments { get; set; }
    [Parameter] public Dictionary<int, List<Comments>>? PostComments { get; set; }
    [Parameter] public Dictionary<int, string>? CommentDrafts { get; set; }

    // Reply Data (New)
    [Parameter] public Dictionary<int, bool>? ActiveReplyBoxes { get; set; }
    [Parameter] public Dictionary<int, string>? ReplyDrafts { get; set; }

    // Events
    [Parameter] public EventCallback<CommentDraftEventArgs> OnUpdateDraft { get; set; }
    [Parameter] public EventCallback<int> OnSubmitComment { get; set; }
    [Parameter] public EventCallback<int> OnToggleReply { get; set; }
    [Parameter] public EventCallback<ReplyDraftEventArgs> OnUpdateReplyDraft { get; set; }
    [Parameter] public EventCallback<SubmitReplyEventArgs> OnSubmitReply { get; set; }

    [Parameter] public Dictionary<int, int>? CarouselIndices { get; set; }
    [Parameter] public EventCallback<CarouselEventArgs> OnCarouselChange { get; set; }

    private int GetCurrentCarouselIndex(int postId)
    {
        if (CarouselIndices == null || !CarouselIndices.ContainsKey(postId))
            return 0;
        return CarouselIndices[postId];
    }

    private async Task NextSlide(int postId, int totalCount)
    {
        var currentIndex = GetCurrentCarouselIndex(postId);
        var newIndex = (currentIndex + 1) % totalCount;
        await OnCarouselChange.InvokeAsync(new CarouselEventArgs { PostId = postId, Index = newIndex });
    }

    private async Task PrevSlide(int postId, int totalCount)
    {
        var currentIndex = GetCurrentCarouselIndex(postId);
        var newIndex = (currentIndex - 1 + totalCount) % totalCount;
        await OnCarouselChange.InvokeAsync(new CarouselEventArgs { PostId = postId, Index = newIndex });
    }

    private void NavigateToCategory(int categoryId)
    {
        Navigation.NavigateTo($"/category/{categoryId}", forceLoad: true);
    }

    // Argument Classes
    public class CommentDraftEventArgs
    {
        public int PostId { get; set; }
        public string? Content { get; set; }
    }

    public class ReplyDraftEventArgs
    {
        public int ParentCommentId { get; set; }
        public string? Content { get; set; }
    }

    public class SubmitReplyEventArgs
    {
        public int PostId { get; set; }
        public int ParentCommentId { get; set; }
    }

    public class CarouselEventArgs
    {
        public int PostId { get; set; }
        public int Index { get; set; }
    }
}