@using SoSuSaFsd.Domain
@using SoSuSaFsd.Components.Common.PostCardComponents

<div class="comment-section">
    <div class="comment-list">
        @if (Comments != null && Comments.Any())
        {
            var parentComments = Comments.Where(c => c.ParentCommentID == null).OrderBy(c => c.DateCreated);

            @foreach (var comment in parentComments)
            {
                var replies = Comments.Where(c => c.ParentCommentID == comment.Id).OrderBy(c => c.DateCreated).ToList();

                @* Parent Comment *@
                <div class="comment-item">
                    <div class="comment-avatar" style="background-image: url('@(comment.User?.ProfileImage ?? "")');"></div>
                    <div style="flex: 1;">
                        <div class="comment-bubble">
                            <div>
                                <span class="comment-user">@(comment.User?.UserName ?? "User")</span>
                                <span class="comment-date">@comment.DateCreated.ToString("MMM dd, HH:mm")</span>
                            </div>
                            <div class="comment-text">@comment.Content</div>
                        </div>
                        <div style="margin-top: 2px; margin-left: 10px;">
                            <button style="background:none; border:none; cursor:pointer; font-size:11px; color:#666; font-weight:600;"
                                    @onclick="() => OnToggleReply.InvokeAsync(comment.Id)">
                                Reply
                            </button>
                        </div>
                    </div>
                </div>

                @* Nested Replies *@
                @if (replies.Any())
                {
                    <div style="margin-left: 45px; border-left: 2px solid #eee; padding-left: 10px; margin-bottom: 10px;">
                        @foreach (var reply in replies)
                        {
                            <div class="comment-item" style="margin-bottom: 8px;">
                                <div class="comment-avatar" style="width: 24px; height: 24px; background-image: url('@(reply.User?.ProfileImage ?? "")');"></div>
                                <div class="comment-bubble" style="padding: 8px 12px;">
                                    <div>
                                        <span class="comment-user" style="font-size: 11px;">@(reply.User?.UserName ?? "User")</span>
                                        <span class="comment-date" style="font-size: 10px;">@reply.DateCreated.ToString("MMM dd, HH:mm")</span>
                                    </div>
                                    <div class="comment-text" style="font-size: 13px;">@reply.Content</div>
                                </div>
                            </div>
                        }
                    </div>
                }

                @* Reply Input Box *@
                @if (ActiveReplyBoxes.ContainsKey(comment.Id) && ActiveReplyBoxes[comment.Id])
                {
                    <div style="margin-left: 45px; margin-bottom: 15px; display: flex; gap: 5px;">
                        <input type="text" class="comment-input" style="font-size: 13px; padding: 6px;" placeholder="Write a reply..."
                               value="@(ReplyDrafts.ContainsKey(comment.Id) ? ReplyDrafts[comment.Id] : "")"
                               @oninput="@(e => OnUpdateReplyDraft.InvokeAsync(new PostCardComments.ReplyDraftEventArgs { ParentCommentId = comment.Id, Content = e.Value?.ToString() ?? "" }))"
                               @onkeydown="@(e => e.Key == "Enter" ? OnSubmitReply.InvokeAsync(new PostCardComments.SubmitReplyEventArgs { PostId = PostId, ParentCommentId = comment.Id }) : null)" />
                        <button class="comment-send-btn" style="padding: 0 10px; font-size: 12px;"
                                @onclick="() => OnSubmitReply.InvokeAsync(new PostCardComments.SubmitReplyEventArgs { PostId = PostId, ParentCommentId = comment.Id })">
                            Reply
                        </button>
                    </div>
                }
            }
        }
    </div>

    @* Main Comment Input *@
    <div class="comment-input-area">
        <input type="text" class="comment-input" placeholder="Write a comment..."
               value="@CommentDraft"
               @oninput="@(e => OnUpdateDraft.InvokeAsync(new PostCardComments.CommentDraftEventArgs { PostId = PostId, Content = e.Value?.ToString() ?? "" }))"
               @onkeydown="@(e => e.Key == "Enter" ? OnSubmitComment.InvokeAsync(PostId) : null)" />
        <button class="comment-send-btn" @onclick="() => OnSubmitComment.InvokeAsync(PostId)">Post</button>
    </div>
</div>

@code {
    [Parameter] public int PostId { get; set; }
    [Parameter] public List<Comments> Comments { get; set; } = new();
    [Parameter] public string CommentDraft { get; set; } = string.Empty;
    [Parameter] public Dictionary<int, bool> ActiveReplyBoxes { get; set; } = new();
    [Parameter] public Dictionary<int, string> ReplyDrafts { get; set; } = new();
    [Parameter] public EventCallback<PostCardComments.CommentDraftEventArgs> OnUpdateDraft { get; set; }
    [Parameter] public EventCallback<int> OnSubmitComment { get; set; }
    [Parameter] public EventCallback<int> OnToggleReply { get; set; }
    [Parameter] public EventCallback<PostCardComments.ReplyDraftEventArgs> OnUpdateReplyDraft { get; set; }
    [Parameter] public EventCallback<PostCardComments.SubmitReplyEventArgs> OnSubmitReply { get; set; }
}