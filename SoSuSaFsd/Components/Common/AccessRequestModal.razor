@using SoSuSaFsd.Domain
@using Microsoft.AspNetCore.Components.Forms
@inject IJSRuntime JS

@* AccessRequestModal - Shared modal for requesting category access *@

@if (ShowModal)
{
    <div class="modal-overlay" @onclick="OnClose" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;">
        <div class="modal-content" @onclick:stopPropagation style="max-width: 500px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="padding: 20px; border-bottom: 1px solid #ddd;">
                <h2 style="margin: 0;">Request Category Access</h2>
                <button class="close-btn" @onclick="OnClose" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
            </div>
            
            <div class="modal-body" style="padding: 20px;">
                <p style="margin-bottom: 20px; color: #666;">
                    Request access to post in <strong># @CategoryName</strong>. Your request will be reviewed by administrators.
                </p>

                @if (!string.IsNullOrEmpty(StatusMessage))
                {
                    <div class="@(IsSuccess ? "success-msg" : "error-msg")" style="margin-bottom: 15px;">
                        @StatusMessage
                    </div>
                }

                @if (ExistingRequest != null)
                {
                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong>Previous Request</strong>
                            <span style="padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold; text-transform: uppercase; background: @(ExistingRequest.Status == "Approved" ? "#d4edda" : ExistingRequest.Status == "Rejected" ? "#f8d7da" : "#fff3cd"); color: @(ExistingRequest.Status == "Approved" ? "#155724" : ExistingRequest.Status == "Rejected" ? "#721c24" : "#856404");">
                                @ExistingRequest.Status
                            </span>
                        </div>
                        <div style="font-size: 13px; color: #666; margin-bottom: 8px;">
                            Submitted: @ExistingRequest.DateCreated.ToString("MMM dd, yyyy 'at' h:mm tt")
                        </div>
                        @if (ExistingRequest.Status == "Rejected" && ExistingRequest.DateUpdated != DateTime.MinValue)
                        {
                            var canResubmitDate = ExistingRequest.DateUpdated.AddDays(7);
                            var daysRemaining = (canResubmitDate - DateTime.Now).TotalDays;
                            
                            <div style="font-size: 13px; color: #666; margin-bottom: 8px;">
                                Rejected: @ExistingRequest.DateUpdated.ToString("MMM dd, yyyy 'at' h:mm tt")
                            </div>
                            
                            @if (daysRemaining > 0)
                            {
                                <div style="padding: 10px; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 4px; font-size: 13px; color: #856404;">
                                    <strong>Cooldown Period</strong><br/>
                                    You can resubmit on: <strong>@canResubmitDate.ToString("MMM dd, yyyy 'at' h:mm tt")</strong><br/>
                                    <span style="font-size: 12px;">(@Math.Ceiling(daysRemaining) day(s) remaining)</span>
                                </div>
                            }
                            else
                            {
                                <div style="padding: 10px; background: #d4edda; border-left: 3px solid #28a745; border-radius: 4px; font-size: 13px; color: #155724;">
                                    <strong>You can now resubmit your request</strong>
                                </div>
                            }
                        }
                        @if (!string.IsNullOrEmpty(ExistingRequest.Reason))
                        {
                            <div style="font-size: 13px; color: #555; margin-top: 8px;">
                                <strong>Previous Reason:</strong> @ExistingRequest.Reason
                            </div>
                        }
                    </div>
                }

                <form @onsubmit="HandleSubmit" @onsubmit:preventDefault>
                    <div class="settings-form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            Reason for Request <span style="color: red;">*</span>
                        </label>
                        <textarea rows="5" 
                                  @bind="RequestReason" 
                                  placeholder="Explain why you need access (e.g., journalist credentials, verified student status, official representative, etc.)"
                                  style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box; resize: vertical;"
                                  disabled="@IsSubmitting"></textarea>
                    </div>

                    <div class="settings-form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            Supporting Document (Optional)
                            <span style="font-size: 12px; color: #666; font-weight: normal; margin-left: 5px;">
                                (PDF, JPG, PNG - Max 5MB)
                            </span>
                        </label>
                        <div style="border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; background: #f9f9f9; cursor: pointer; transition: all 0.2s;"
                             @onclick="TriggerFileInput">
                            @if (string.IsNullOrEmpty(selectedFileName))
                            {
                                <div>
                                    <i class="fas fa-cloud-upload-alt" style="font-size: 36px; color: #999; margin-bottom: 10px;"></i>
                                    <p style="margin: 0; color: #666; font-size: 14px;">
                                        <strong>Click to upload</strong> or drag and drop<br/>
                                        Student ID, Press Card, Verification Letter, etc.
                                    </p>
                                </div>
                            }
                            else
                            {
                                <div>
                                    <i class="fas fa-file-alt" style="font-size: 36px; color: #4CAF50; margin-bottom: 10px;"></i>
                                    <p style="margin: 0; color: #333; font-size: 14px;">
                                        <strong>@selectedFileName</strong><br/>
                                        <span style="color: #666; font-size: 12px;">@selectedFileSize</span>
                                    </p>
                                    <button type="button" 
                                            @onclick="ClearFile" 
                                            @onclick:stopPropagation="true"
                                            class="login-btn secondary" 
                                            style="margin-top: 10px; font-size: 12px; padding: 5px 15px;">
                                        Remove File
                                    </button>
                                </div>
                            }
                        </div>
                        <InputFile @ref="fileInput" 
                                   OnChange="HandleFileSelected" 
                                   accept=".pdf,.jpg,.jpeg,.png" 
                                   style="display: none;" 
                                   disabled="@IsSubmitting" />
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" class="login-btn secondary" @onclick="OnClose" disabled="@IsSubmitting">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="login-btn" 
                                disabled="@(IsSubmitting || string.IsNullOrWhiteSpace(RequestReason) || !CanSubmit)"
                                style="display: flex; align-items: center; gap: 8px;">
                            @if (IsSubmitting)
                            {
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>Submitting...</span>
                            }
                            else
                            {
                                <i class="fas fa-paper-plane"></i>
                                <span>@(ExistingRequest?.Status == "Rejected" && CanResubmit ? "Resubmit Request" : "Submit Request")</span>
                            }
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool ShowModal { get; set; }
    [Parameter] public string CategoryName { get; set; } = string.Empty;
    [Parameter] public int CategoryId { get; set; }
    [Parameter] public CategoryAccessRequests? ExistingRequest { get; set; }
    [Parameter] public string StatusMessage { get; set; } = string.Empty;
    [Parameter] public bool IsSuccess { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<(int CategoryId, string Reason, IBrowserFile? File)> OnSubmit { get; set; }

    private string RequestReason { get; set; } = string.Empty;
    private bool IsSubmitting { get; set; }
    private InputFile? fileInput;
    private string selectedFileName = string.Empty;
    private string selectedFileSize = string.Empty;
    private IBrowserFile? selectedFile;

    private bool CanSubmit
    {
        get
        {
            if (ExistingRequest == null) return true;
            
            if (ExistingRequest.Status == "Pending") return false;
            if (ExistingRequest.Status == "Approved") return false;
            
            if (ExistingRequest.Status == "Rejected")
            {
                return CanResubmit;
            }
            
            return true;
        }
    }

    private bool CanResubmit
    {
        get
        {
            if (ExistingRequest == null || ExistingRequest.Status != "Rejected") 
                return false;
                
            var canResubmitDate = ExistingRequest.DateUpdated.AddDays(7);
            return DateTime.Now >= canResubmitDate;
        }
    }

    protected override void OnParametersSet()
    {
        if (ShowModal && string.IsNullOrEmpty(RequestReason))
        {
            RequestReason = string.Empty;
            selectedFileName = string.Empty;
            selectedFileSize = string.Empty;
            selectedFile = null;
        }
    }

    private async Task TriggerFileInput()
    {
        if (!IsSubmitting && fileInput?.Element != null)
        {
            await JS.InvokeVoidAsync("eval", "document.querySelector('input[type=file][style*=none]').click()");
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        
        if (file.Size > 5 * 1024 * 1024)
        {
            StatusMessage = "File size must be less than 5MB";
            IsSuccess = false;
            StateHasChanged();
            return;
        }
        
        selectedFile = file;
        selectedFileName = file.Name;
        selectedFileSize = FormatFileSize(file.Size);
        StatusMessage = string.Empty;
        StateHasChanged();
    }

    private void ClearFile()
    {
        selectedFile = null;
        selectedFileName = string.Empty;
        selectedFileSize = string.Empty;
        StateHasChanged();
    }

    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }

    private async Task HandleSubmit()
    {
        if (string.IsNullOrWhiteSpace(RequestReason) || !CanSubmit)
            return;

        IsSubmitting = true;
        StateHasChanged();

        try
        {
            await OnSubmit.InvokeAsync((CategoryId, RequestReason, selectedFile));
            RequestReason = string.Empty;
            selectedFile = null;
            selectedFileName = string.Empty;
            selectedFileSize = string.Empty;
        }
        finally
        {
            IsSubmitting = false;
            StateHasChanged();
        }
    }
}
